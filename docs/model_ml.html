<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>US Credit Card Partnerships - 9&nbsp; XGBoost Model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./model_event_summary.html" rel="next">
<link href="./model_hierarchy_event.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./model_event.html">Event Study</a></li><li class="breadcrumb-item"><a href="./model_ml.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">XGBoost Model</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">US Credit Card Partnerships</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_ffiec.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bank Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_partners.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bank Partnerships</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_fed.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Explanatory Data</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Event Study</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_event.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Event Studies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_market.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Market Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_arima.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Linear Regression with AR Errors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_hierarchy_event.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Hierarchical Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_ml.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">XGBoost Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_event_summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Overall Results</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Hierarchical Study</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_hierarchy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Hierarchical study</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_hierarchy_extra.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Hierarchical study - extra</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Appendix</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_banks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Bank Peer Groups</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_final_event.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Event Study Dataset</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_final_hierarchy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Hierarchical Study Dataset</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-xgboost-data" id="toc-sec-xgboost-data" class="nav-link active" data-scroll-target="#sec-xgboost-data"><span class="header-section-number">9.1</span> Data Preparation</a></li>
  <li><a href="#model-hyperparameter-tuning" id="toc-model-hyperparameter-tuning" class="nav-link" data-scroll-target="#model-hyperparameter-tuning"><span class="header-section-number">9.2</span> Model Hyperparameter Tuning</a></li>
  <li><a href="#traintest-split-validation" id="toc-traintest-split-validation" class="nav-link" data-scroll-target="#traintest-split-validation"><span class="header-section-number">9.3</span> Train/Test Split Validation</a></li>
  <li><a href="#sec-xgboost-feature" id="toc-sec-xgboost-feature" class="nav-link" data-scroll-target="#sec-xgboost-feature"><span class="header-section-number">9.4</span> Feature Selection</a></li>
  <li><a href="#estimated-fit" id="toc-estimated-fit" class="nav-link" data-scroll-target="#estimated-fit"><span class="header-section-number">9.5</span> Estimated Fit</a></li>
  <li><a href="#shapley" id="toc-shapley" class="nav-link" data-scroll-target="#shapley"><span class="header-section-number">9.6</span> Shapley</a>
  <ul class="collapse">
  <li><a href="#sec-residual-check-xgboost" id="toc-sec-residual-check-xgboost" class="nav-link" data-scroll-target="#sec-residual-check-xgboost"><span class="header-section-number">9.6.1</span> Residual diagnostics</a></li>
  </ul></li>
  <li><a href="#prediction" id="toc-prediction" class="nav-link" data-scroll-target="#prediction"><span class="header-section-number">9.7</span> Prediction</a></li>
  <li><a href="#abnormal-results" id="toc-abnormal-results" class="nav-link" data-scroll-target="#abnormal-results"><span class="header-section-number">9.8</span> Abnormal Results</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">XGBoost Model</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="sec-xgboost-data" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="sec-xgboost-data"><span class="header-section-number">9.1</span> Data Preparation</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"functions.R"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shapviz)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>target_label <span class="ot">&lt;-</span> <span class="fu">credit_card.target_label</span>()</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>run_xgb.cv <span class="ot">&lt;-</span> <span class="cf">function</span>(dtrain) {</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>),</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.1</span>,<span class="fl">0.2</span>),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">colsample_bytree =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.8</span>),</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_child_weight =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>),</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">subsample =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.75</span>),</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Placeholder for cross-validation results</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  cv_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(param_grid))) {</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">booster =</span> <span class="st">"gbtree"</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">eta =</span> param_grid<span class="sc">$</span>eta[i],</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_depth =</span> param_grid<span class="sc">$</span>max_depth[i],</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">subsample =</span> param_grid<span class="sc">$</span>subsample[i],</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">colsample_bytree =</span> param_grid<span class="sc">$</span>colsample_bytree[i],</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_child_weight =</span> param_grid<span class="sc">$</span>min_child_weight[i],</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> param_grid<span class="sc">$</span>alpha[i],</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">lambda =</span> param_grid<span class="sc">$</span>lambda[i],</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">objective =</span> <span class="st">"reg:squarederror"</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    cv <span class="ot">&lt;-</span> <span class="fu">xgb.cv</span>(<span class="at">params =</span> params, <span class="at">data =</span> dtrain, <span class="at">nrounds =</span> <span class="dv">100</span>, <span class="at">nfold =</span> <span class="dv">5</span>, <span class="at">early_stopping_rounds =</span> <span class="dv">10</span>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    cv_results[[i]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">params =</span> params, <span class="at">cv_metrics =</span> cv)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  best_score <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(cv_results)) {</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    score <span class="ot">&lt;-</span> <span class="fu">min</span>(cv_results[[i]]<span class="sc">$</span>cv_metrics<span class="sc">$</span>evaluation_log)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(score <span class="sc">&lt;</span> best_score) {</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>      best_score <span class="ot">&lt;-</span> score</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>      best_model <span class="ot">&lt;-</span> cv_results[[i]]</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  best_model<span class="sc">$</span>cv_metrics[<span class="dv">4</span>]<span class="sc">$</span>evaluation_log <span class="sc">|&gt;</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(<span class="st">"data/results/xgboost_cv_metrics.csv"</span>)</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  best_model<span class="sc">$</span>params <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(<span class="st">"data/results/xgboost_cv_params.csv"</span>)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>run_xgb.caret.cv <span class="ot">&lt;-</span> <span class="cf">function</span>(train.predictors, train.outcome, n_folds, n_repeats, model_name, <span class="at">method =</span> <span class="st">"xgbTree"</span>, seeds) {</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"xgbTree"</span>) {</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">eta =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>),</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>                        <span class="at">max_depth =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>),</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>                        <span class="at">gamma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>),</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>                        <span class="at">colsample_bytree =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.8</span>),</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>                        <span class="at">min_child_weight =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>),</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>                        <span class="at">subsample =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.75</span>),</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nrounds =</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">150</span>,<span class="dv">200</span>)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">eta =</span> <span class="fl">0.01</span>,</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>                        <span class="at">alpha =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>                        <span class="at">lambda =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">50</span>),</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nrounds =</span> <span class="dv">100</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>  control <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"repeatedcv"</span>, <span class="at">number =</span> n_folds, <span class="at">repeats =</span> n_repeats, <span class="at">seeds =</span> seeds)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Train the model</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">train</span>(train.predictors, train.outcome,</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> method,</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>                <span class="at">trControl =</span> control,</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>                <span class="at">tuneGrid =</span> grid,</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>                <span class="at">metric =</span> <span class="st">"RMSE"</span>)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the plot</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="fu">glue</span>(<span class="st">"data/results/{method}_tuning_plot_{model_name}.png"</span>), <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(model)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>() </span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  <span class="co">#save tuning results</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>results  <span class="sc">|&gt;</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(<span class="fu">glue</span>(<span class="st">"data/results/{method}_tuning_results_{model_name}.csv"</span>))</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>bestTune <span class="sc">|&gt;</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(<span class="fu">glue</span>(<span class="st">"data/results/{method}_best_tune_{model_name}.csv"</span>))</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xgb.save</span>(<span class="at">model =</span> model<span class="sc">$</span>finalModel, <span class="at">fname =</span> <span class="fu">glue</span>(<span class="st">"data/results/best_{method}_{model_name}.model"</span>))</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the number of folds and repeats</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>get_cv_params <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>  n_folds <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>  n_repeats <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>  seeds <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(n_folds <span class="sc">*</span> n_repeats), <span class="cf">function</span>(x) <span class="fu">sample.int</span>(<span class="dv">1000</span>, <span class="dv">144</span>))</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>  seeds[[<span class="fu">length</span>(seeds) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="dv">1000</span>, <span class="dv">1</span>)  <span class="co"># The last seed for the final model</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">n_folds =</span> n_folds, <span class="at">n_repeats =</span> n_repeats, <span class="at">seeds =</span> seeds)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>bank_fit_result <span class="ot">&lt;-</span> <span class="cf">function</span>(bankname, data, <span class="at">train_test =</span> <span class="st">"Train"</span>, <span class="at">target_name =</span> <span class="st">"UBPRE524.diff"</span>) {</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    X_filtered <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(BankName <span class="sc">==</span> bankname) <span class="sc">|&gt;</span> <span class="fu">pull</span>(predictions)</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    Y_filtered <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(BankName <span class="sc">==</span> bankname) <span class="sc">|&gt;</span> <span class="fu">pull</span>(target_name)</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>    caret<span class="sc">::</span><span class="fu">postResample</span>(<span class="at">pred =</span> X_filtered, <span class="at">obs =</span> Y_filtered) <span class="sc">|&gt;</span> <span class="fu">t</span>() <span class="sc">|&gt;</span><span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_column</span>(<span class="at">BankName =</span> bankname,</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>                 <span class="at">.type =</span> train_test) <span class="sc">|&gt;</span> <span class="fu">relocate</span>(BankName,.type)</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"metrics error for {bankname}: {e}"</span>))</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>run_validation <span class="ot">&lt;-</span> <span class="cf">function</span>(model, params, model_name) {</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">booster =</span> <span class="st">"gbtree"</span>, <span class="at">data =</span> model<span class="sc">$</span>dtrain, <span class="at">params=</span> params, <span class="at">nrounds=</span>params<span class="sc">$</span>nrounds)</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>  bank_types <span class="ot">&lt;-</span>  model<span class="sc">$</span>train <span class="sc">|&gt;</span> <span class="fu">distinct</span>(BankName, BankType)</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Training fit</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>  train_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, model<span class="sc">$</span>dtrain)</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>  <span class="co"># See Fit on unseen data: Generate Predictions</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>  test_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, model<span class="sc">$</span>dtest)</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>  train_result <span class="ot">&lt;-</span> model<span class="sc">$</span>train <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">predictions =</span> train_predictions)</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>  test_result <span class="ot">&lt;-</span> model<span class="sc">$</span>test <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">predictions =</span> test_predictions)</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>  results_est <span class="ot">&lt;-</span> <span class="fu">unique</span>(model<span class="sc">$</span>train<span class="sc">$</span>BankName) <span class="sc">|&gt;</span> </span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">map</span>(bank_fit_result,train_result, <span class="st">"Train"</span>) <span class="sc">|&gt;</span> <span class="fu">list_rbind</span>()</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>  results_test <span class="ot">&lt;-</span> <span class="fu">unique</span>(model<span class="sc">$</span>train<span class="sc">$</span>BankName) <span class="sc">|&gt;</span> </span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">map</span>(bank_fit_result,test_result, <span class="st">"Test"</span>) <span class="sc">|&gt;</span> <span class="fu">list_rbind</span>()</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>  comb <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_est, results_test) <span class="sc">|&gt;</span> <span class="fu">left_join</span>(bank_types, <span class="at">by =</span> <span class="fu">join_by</span>(BankName)) <span class="sc">|&gt;</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(BankName, BankType, .type, RMSE, MAE, Rsquared)</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>  comb <span class="sc">|&gt;</span> <span class="fu">write_csv</span>(<span class="fu">glue</span>(<span class="st">"data/results/xgbTree_validation_{model_name}.csv"</span>))  </span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>  importance_matrix  <span class="ot">&lt;-</span> <span class="fu">xgb.importance</span>(<span class="fu">names</span>(model<span class="sc">$</span>dtrain), <span class="at">model =</span> m)</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>  importance_matrix <span class="sc">|&gt;</span> <span class="fu">write_csv</span>(<span class="fu">glue</span>(<span class="st">"data/results/xgbTree_importmatrix_{model_name}.csv"</span>)) </span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>  <span class="co">#save images</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>  shap_train <span class="ot">&lt;-</span> <span class="fu">shapviz</span>(m,<span class="at">X_pred =</span> model<span class="sc">$</span>dtrain,<span class="at">X=</span><span class="fu">data.matrix</span>(model<span class="sc">$</span>train.predictors))</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>  shap_test <span class="ot">&lt;-</span> <span class="fu">shapviz</span>(m,<span class="at">X_pred =</span> model<span class="sc">$</span>dtest,<span class="at">X=</span><span class="fu">data.matrix</span>(model<span class="sc">$</span>test.predictors))</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="fu">glue</span>(<span class="st">"images/xgb_train_imp_{model_name}.png"</span>), <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>)</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sv_importance</span>(shap_train, <span class="at">kind =</span> <span class="st">"beeswarm"</span>, <span class="at">show_numbers =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="fu">glue</span>(<span class="st">"images/xgb_test_imp_{model_name}.png"</span>), <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>)</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sv_importance</span>(shap_test, <span class="at">kind =</span> <span class="st">"beeswarm"</span>, <span class="at">show_numbers =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="fu">glue</span>(<span class="st">"images/xgb_train_water_{model_name}.png"</span>), <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>)</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sv_waterfall</span>(shap_train)</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="fu">glue</span>(<span class="st">"images/xgb_test_water_{model_name}.png"</span>), <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>)</span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sv_waterfall</span>(shap_test)</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>map_prediction_to_partner <span class="ot">&lt;-</span> <span class="cf">function</span>(Bank, Partner, obs_data_w_qtr, all_data) {</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>  event_data <span class="ot">&lt;-</span> obs_data_w_qtr <span class="sc">|&gt;</span> </span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">filter</span>(BankName <span class="sc">==</span> Bank) <span class="sc">|&gt;</span> </span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">as.name</span>(Partner) <span class="sc">&gt;=</span><span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">8</span>) </span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>  min_qtr <span class="ot">&lt;-</span> event_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(Quarter <span class="sc">==</span> <span class="fu">min</span>(Quarter)) <span class="sc">|&gt;</span> <span class="fu">pull</span>(Quarter)</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>  value0 <span class="ot">&lt;-</span> all_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(BankName <span class="sc">==</span> Bank, Quarter <span class="sc">==</span> (min_qtr <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> <span class="fu">pull</span>(UBPRE524.Value)</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>  event_data <span class="sc">|&gt;</span> </span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">observed =</span> UBPRE524.Value, <span class="at">predicted =</span> value0 <span class="sc">+</span> <span class="fu">cumsum</span>(prediction))<span class="sc">|&gt;</span> </span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_column</span>(<span class="at">Partner =</span> Partner)</span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In our previous models, we utilised a panel dataset that captured temporal dynamics. However, machine learning algorithms require a dataset structured to reflect a single timeframe. Consequently, we need to transform our panel data into a cross-sectional format.</p>
<p>This entailed:</p>
<ul>
<li><p>Removing time-related factor Quarter (for example, 2020 Q1).</p></li>
<li><p>Excluding lagged values of the Credit Card Plans-30-89 DAYS P/D % to prevent look-ahead bias. This ensures that our model does not inadvertently learn from future information which could result in overfitting.</p></li>
<li><p>Excluding variables that are close proxies for Credit Card Plans-30-89 DAYS P/D %, as listed in <a href="#tbl-xgboost-bias">Table&nbsp;<span>9.1</span></a>. These variables are closely tied to the target variable as they reflect ongoing delinquency beyond a 30-day period. This means that the model can indirectly learn future information which could result in overfitting.</p></li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_ubpr_labels</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(Code <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"UBPRE411"</span>, <span class="st">"UBPRE523"</span>, <span class="st">"UBPRE521"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Code, <span class="at">Description =</span> Desc) <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">format =</span> <span class="st">"html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-xgboost-bias" class="anchored">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Table&nbsp;9.1: Removed proxy features</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Code</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">UBPRE521</td>
<td style="text-align: left;">Credit Card Plans-90+ Days P/D %</td>
</tr>
<tr class="even">
<td style="text-align: left;">UBPRE523</td>
<td style="text-align: left;">90 days+ Nonaccrual (UBPRE521+UBPRE522)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">UBPRE411</td>
<td style="text-align: left;">Credit Card Plans Net Losses (%)</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">get_model_data</span>()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>all_data <span class="ot">&lt;-</span> model_data<span class="sc">$</span>all_data <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()           </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>partner_banks <span class="ot">&lt;-</span> <span class="fu">credit_card.partnerships.long</span>()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>estimation_data <span class="ot">&lt;-</span> model_data<span class="sc">$</span>estimation_data</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>observation_data <span class="ot">&lt;-</span> model_data<span class="sc">$</span>observation_data</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>log_cols_wo_group <span class="ot">&lt;-</span> all_data <span class="sc">|&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">".log.diff"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"UBPRE524.log.diff"</span>), </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">starts_with</span>(<span class="st">"UBPRE524.group"</span>), </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">starts_with</span>(<span class="st">"UBPRE524.all"</span>)))  <span class="sc">|&gt;</span> <span class="fu">names</span>() </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>setup_train_test <span class="ot">&lt;-</span> <span class="cf">function</span>(estimation_data, predictor_cols) {</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> estimation_data <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(UBPRE524.diff, BankName, BankType, <span class="fu">all_of</span>(predictor_cols), Qtr))  </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(data<span class="sc">$</span>UBPRE524.diff, <span class="at">p =</span> <span class="fl">0.70</span>, <span class="at">list=</span><span class="cn">FALSE</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  training <span class="ot">&lt;-</span> data[s,]</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> data[<span class="sc">-</span>s,]</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the data to matrix and assign output variable</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  train.outcome <span class="ot">&lt;-</span> training<span class="sc">$</span>UBPRE524.diff</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  train.predictors <span class="ot">&lt;-</span> <span class="fu">sparse.model.matrix</span>(UBPRE524.diff <span class="sc">~</span> .<span class="sc">-</span><span class="dv">1</span>, <span class="at">data =</span> training)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  test.outcome <span class="ot">&lt;-</span> test<span class="sc">$</span>UBPRE524.diff</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  test.predictors <span class="ot">&lt;-</span> <span class="fu">sparse.model.matrix</span>(UBPRE524.diff <span class="sc">~</span> .<span class="sc">-</span><span class="dv">1</span>, <span class="at">data =</span> test)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the matrix objects to DMatrix objects</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  dtrain <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(train.predictors, <span class="at">label =</span> train.outcome)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  dtest <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(test.predictors, <span class="at">label =</span> test.outcome)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">train =</span> training, <span class="at">test =</span> test, <span class="at">dtrain =</span> dtrain, <span class="at">dtest =</span> dtest, <span class="at">train.predictors =</span> train.predictors, </span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">test.predictors =</span> test.predictors, <span class="at">train.outcome =</span> train.outcome, <span class="at">test.outcome =</span> test.outcome)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>model_without_group <span class="ot">&lt;-</span> <span class="fu">setup_train_test</span>(estimation_data, log_cols_wo_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>3 datasets were tested:</p>
<ul>
<li><em>All data</em> - note group Credit Card Plans-30-89 DAYS P/D % features removed.</li>
<li><em>Selected features</em>. To see if a simpler model would generalise better on unseen test data, a dataset of the top 10 important features from the <em>All data</em> model was selected (see <a href="#sec-xgboost-feature"><span>Section&nbsp;9.4</span></a>).</li>
</ul>
<p>Furthermore, the seasonal factor <em>Qtr</em> (ranging from 1 to 4) was added to all datasets. Initial model testing revealed distinct seasonal trends in the residuals, as identified in the Autocorrelation Function (ACF) plots. Introducing <em>Qtr</em> attempts to help the model account for these seasonal patterns. An alternative approach could have involved de-seasonalising the data.</p>
</section>
<section id="model-hyperparameter-tuning" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="model-hyperparameter-tuning"><span class="header-section-number">9.2</span> Model Hyperparameter Tuning</h2>
<p>In XGBoost we can tune the model hyperparameters e.g., maximum tree depth, to regularise the model so it does not overfit the training data.</p>
<p>We use Cross Validation to explore the hyperparameter space. This process helps identify the combination of parameters that best balance between overfitting (by avoiding too high variance) and underfitting (by avoiding too high bias).</p>
<p>We used 5-Fold Cross-Validation, repeated 3 times - each time with a different random division of the dataset into 5 folds. This means cross validation was performed a total of 15 train-test splits (3 repeats  5 folds) to get an overall performance estimate.</p>
<p>We can see from <a href="#fig-xgcv-wo-group">Figure&nbsp;<span>9.1</span></a> that changes to the ETA hyperparameter, in particular, impacted the RMSE metric. ETA (value between 0 and 1) determines the weight of each trees contribution to the final model. A smaller ETA means making smaller updates so the model is less likely to make large adjustments based on any single observation or pattern in the data i.e.&nbsp;it reduces the impact of outliers or noise. An eta of 0.1 for all datasets (see <a href="#tbl-xgboost-param">Table&nbsp;<span>9.2</span></a>) was selected.</p>
<div class="tabset-margin-container"></div><div id="panel-xgtuning" class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">All Data</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Selected Features</a></li></ul>
<div id="panel-xgtuning" class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div id="fig-xgcv-wo-group" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/xgbTree_tuning_plot_model_without_group.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;9.1: Parameter Tuning for model without group features</figcaption>
</figure>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div id="fig-xgcv-selected" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/xgbTree_tuning_plot_model_select.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;9.2: Parameter Tuning for model with selected features</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>params_wo_group <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/results/xgbTree_best_tune_model_without_group.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">add_column</span>(<span class="at">model =</span> <span class="st">"All Data"</span>) <span class="sc">|&gt;</span> <span class="fu">as.list</span>()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>params_select_group <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/results/xgbTree_best_tune_model_select.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">add_column</span>(<span class="at">model =</span> <span class="st">"Selected"</span>) <span class="sc">|&gt;</span> <span class="fu">as.list</span>()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(params_wo_group,params_select_group) <span class="sc">|&gt;</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="sc">-</span>model)) <span class="sc">|&gt;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from=</span><span class="fu">c</span>(model)) <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="tbl-xgboost-param" class="anchored">

<div data-pagedtable="false"> <div class="table-caption">Table&nbsp;9.2:  <p>Optimal tuning model parameters for each dataset</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["name"],"name":[1],"type":["chr"],"align":["left"]},{"label":["All Data"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Selected"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"nrounds","2":"150.00","3":"100.00"},{"1":"max_depth","2":"9.00","3":"9.00"},{"1":"eta","2":"0.10","3":"0.10"},{"1":"gamma","2":"0.00","3":"0.10"},{"1":"colsample_bytree","2":"0.50","3":"0.50"},{"1":"min_child_weight","2":"1.00","3":"1.00"},{"1":"subsample","2":"0.75","3":"0.75"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</div>
</section>
<section id="traintest-split-validation" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="traintest-split-validation"><span class="header-section-number">9.3</span> Train/Test Split Validation</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">run_validation</span>(model_without_group, params_wo_group,<span class="st">"wo_group"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <em>Selected Feature</em> dataset across all banks (<a href="#tbl-xgtest-select">Table&nbsp;<span>9.4</span></a>) performed well and had the least discrepancy in our metrics.</p>
<div class="tabset-margin-container"></div><div id="panel-xgboost-test" class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">All Data</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Selected Features</a></li></ul>
<div id="panel-xgboost-test" class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>banks <span class="ot">=</span> <span class="fu">unique</span>(observation_data<span class="sc">$</span>BankName)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>val_wo_results <span class="ot">&lt;-</span> <span class="fu">get_summary_validation.xgboost</span>(<span class="st">"wo_group"</span>, banks)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>val_wo_results<span class="sc">$</span>tbl1 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>val_wo_results<span class="sc">$</span>tbl2 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>val_wo_results<span class="sc">$</span>tbl3 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-xgtest-group" class="cell tbl-parent quarto-layout-panel anchored">
<div class="panel-caption table-caption">
<p>Table&nbsp;9.3: Comparing Accuracy Metrics for Training and Test data#|</p>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-xgtest-group-1" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-xgtest-group" style="flex-basis: 100.0%;justify-content: center;">
<div id="tbl-xgtest-group-1" data-ref-parent="tbl-xgtest-group" class="anchored">

<div data-pagedtable="false"> <div class="table-caption">(a) <p>Accuracy Metrics on Training and Test data for sub-set of banks</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["BankName"],"name":[1],"type":["chr"],"align":["left"]},{"label":["BankType"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".type"],"name":[3],"type":["chr"],"align":["left"]},{"label":["RMSE"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["MAE"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Rsquared"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"AMERICAN EXPRESS NATIONAL BANK (1394676)","2":"LargeCreditCardBank","3":"Test","4":"0.142","5":"0.125","6":"0.231"},{"1":"AMERICAN EXPRESS NATIONAL BANK (1394676)","2":"LargeCreditCardBank","3":"Train","4":"0.063","5":"0.050","6":"0.585"},{"1":"BARCLAYS BANK DELAWARE (2980209)","2":"LargeCreditCardBank","3":"Test","4":"0.115","5":"0.084","6":"0.185"},{"1":"BARCLAYS BANK DELAWARE (2980209)","2":"LargeCreditCardBank","3":"Train","4":"0.060","5":"0.047","6":"0.826"},{"1":"CAPITAL ONE, NATIONAL ASSOCIATION (112837)","2":"LargeBank","3":"Test","4":"0.127","5":"0.096","6":"0.380"},{"1":"CAPITAL ONE, NATIONAL ASSOCIATION (112837)","2":"LargeBank","3":"Train","4":"0.080","5":"0.069","6":"0.791"},{"1":"CITIBANK, N.A. (476810)","2":"LargeBank","3":"Test","4":"0.120","5":"0.096","6":"0.046"},{"1":"CITIBANK, N.A. (476810)","2":"LargeBank","3":"Train","4":"0.102","5":"0.073","6":"0.795"},{"1":"SYNCHRONY BANK (1216022)","2":"LargeCreditCardBank","3":"Test","4":"0.134","5":"0.108","6":"0.683"},{"1":"SYNCHRONY BANK (1216022)","2":"LargeCreditCardBank","3":"Train","4":"0.079","5":"0.068","6":"0.840"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<p><strong>?(caption)</strong></p>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-xgtest-group-2" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-xgtest-group" style="flex-basis: 100.0%;justify-content: center;">
<div id="tbl-xgtest-group-2" data-ref-parent="tbl-xgtest-group" class="anchored">

<div data-pagedtable="false"> <div class="table-caption">(b) <p>Mean Accuracy Metrics for our sub-set of banks</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".type"],"name":[1],"type":["chr"],"align":["left"]},{"label":["RMSE"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["MAE"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Rsquared"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"Test","2":"0.127","3":"0.096","4":"0.231"},{"1":"Train","2":"0.079","3":"0.068","4":"0.795"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<p><strong>?(caption)</strong></p>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-xgtest-group-3" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-xgtest-group" style="flex-basis: 100.0%;justify-content: center;">
<div id="tbl-xgtest-group-3" data-ref-parent="tbl-xgtest-group" class="anchored">

<div data-pagedtable="false"> <div class="table-caption">(c) <p>Mean Accuracy Metrics across all banks</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".type"],"name":[1],"type":["chr"],"align":["left"]},{"label":["RMSE"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["MAE"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Rsquared"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"Test","2":"0.153","3":"0.117","4":"0.355"},{"1":"Train","2":"0.079","3":"0.066","4":"0.810"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<p><strong>?(caption)</strong></p>
</div>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>val_results <span class="ot">&lt;-</span> <span class="fu">get_summary_validation.xgboost</span>(<span class="st">"model_select"</span>, banks)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>val_results<span class="sc">$</span>tbl1 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>val_results<span class="sc">$</span>tbl2 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>val_results<span class="sc">$</span>tbl3 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-xgtest-select" class="cell tbl-parent quarto-layout-panel anchored">
<div class="panel-caption table-caption">
<p>Table&nbsp;9.4: Comparing Accuracy Metrics for Training and Test data</p>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-xgtest-select-1" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-xgtest-select" style="flex-basis: 100.0%;justify-content: center;">
<div id="tbl-xgtest-select-1" data-ref-parent="tbl-xgtest-select" class="anchored">

<div data-pagedtable="false"> <div class="table-caption">(a) <p>Accuracy Metrics on Training and Test data for sub-set of banks</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["BankName"],"name":[1],"type":["chr"],"align":["left"]},{"label":["BankType"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".type"],"name":[3],"type":["chr"],"align":["left"]},{"label":["RMSE"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["MAE"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Rsquared"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"AMERICAN EXPRESS NATIONAL BANK (1394676)","2":"LargeCreditCardBank","3":"Test","4":"0.098","5":"0.081","6":"0.467"},{"1":"AMERICAN EXPRESS NATIONAL BANK (1394676)","2":"LargeCreditCardBank","3":"Train","4":"0.061","5":"0.050","6":"0.481"},{"1":"BARCLAYS BANK DELAWARE (2980209)","2":"LargeCreditCardBank","3":"Test","4":"0.080","5":"0.070","6":"0.556"},{"1":"BARCLAYS BANK DELAWARE (2980209)","2":"LargeCreditCardBank","3":"Train","4":"0.073","5":"0.059","6":"0.652"},{"1":"CAPITAL ONE, NATIONAL ASSOCIATION (112837)","2":"LargeBank","3":"Test","4":"0.128","5":"0.107","6":"0.350"},{"1":"CAPITAL ONE, NATIONAL ASSOCIATION (112837)","2":"LargeBank","3":"Train","4":"0.097","5":"0.080","6":"0.537"},{"1":"CITIBANK, N.A. (476810)","2":"LargeBank","3":"Test","4":"0.029","5":"0.028","6":"0.857"},{"1":"CITIBANK, N.A. (476810)","2":"LargeBank","3":"Train","4":"0.078","5":"0.060","6":"0.893"},{"1":"SYNCHRONY BANK (1216022)","2":"LargeCreditCardBank","3":"Test","4":"0.100","5":"0.095","6":"0.826"},{"1":"SYNCHRONY BANK (1216022)","2":"LargeCreditCardBank","3":"Train","4":"0.092","5":"0.083","6":"0.913"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<p><strong>?(caption)</strong></p>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-xgtest-select-2" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-xgtest-select" style="flex-basis: 100.0%;justify-content: center;">
<div id="tbl-xgtest-select-2" data-ref-parent="tbl-xgtest-select" class="anchored">

<div data-pagedtable="false"> <div class="table-caption">(b) <p>Mean Accuracy Metrics for our sub-set of banks</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".type"],"name":[1],"type":["chr"],"align":["left"]},{"label":["RMSE"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["MAE"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Rsquared"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"Test","2":"0.098","3":"0.081","4":"0.556"},{"1":"Train","2":"0.078","3":"0.060","4":"0.652"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<p><strong>?(caption)</strong></p>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-xgtest-select-3" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-xgtest-select" style="flex-basis: 100.0%;justify-content: center;">
<div id="tbl-xgtest-select-3" data-ref-parent="tbl-xgtest-select" class="anchored">

<div data-pagedtable="false"> <div class="table-caption">(c) <p>Mean Accuracy Metrics across all banks</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".type"],"name":[1],"type":["chr"],"align":["left"]},{"label":["RMSE"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["MAE"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Rsquared"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"Test","2":"0.109","3":"0.089","4":"0.489"},{"1":"Train","2":"0.092","3":"0.066","4":"0.750"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<p><strong>?(caption)</strong></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="sec-xgboost-feature" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="sec-xgboost-feature"><span class="header-section-number">9.4</span> Feature Selection</h2>
<p>The plots below show the Gain (the improvement in accuracy the model gains from including a feature) and Frequency (how often each feature is split on across all boosting tree) of each feature relative to the first feature.</p>
<p>Model uses Household Debt Ratio (TDSP). Generally, portfolio features like <em>Unused Commitments on Credit Cards</em> were more important than exogenous economic measures.</p>
<div class="tabset-margin-container"></div><div id="fig-xgboost-importance" class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">All Data - Gain</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">All Data - Frequency</a></li></ul>
<div id="fig-xgboost-importance" class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>importance_matrix_grp <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/results/xgbTree_importmatrix_wo_group.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>feature_desc <span class="ot">&lt;-</span> <span class="fu">get_feature_labels</span>()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>importance_matrix_lab <span class="ot">&lt;-</span> importance_matrix_grp <span class="sc">|&gt;</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">mutate</span>(<span class="at">Code =</span> stringr<span class="sc">::</span><span class="fu">str_split_i</span>(Feature,<span class="st">"</span><span class="sc">\\</span><span class="st">."</span>,<span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">left_join</span>(feature_desc,<span class="at">by =</span> <span class="fu">join_by</span>(Code)) <span class="sc">|&gt;</span> </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">mutate</span>(<span class="at">Feature =</span> <span class="fu">paste</span>(Feature, <span class="fu">coalesce</span>(Desc,<span class="st">""</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)) <span class="sc">|&gt;</span> <span class="fu">data.table</span>()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.plot.importance</span>(importance_matrix_lab, <span class="at">measure =</span> <span class="st">"Gain"</span>, <span class="at">xlab =</span> <span class="st">"Relative importance"</span>,<span class="at">top_n =</span> <span class="dv">15</span>,<span class="at">left_margin =</span> <span class="dv">30</span>,<span class="at">rel_to_first =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-gain-all" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-gain-all-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.3: Feature importance using Gain</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.ggplot.importance</span>(importance_matrix_lab, <span class="at">measure =</span> <span class="st">"Frequency"</span>, <span class="at">rel_to_first =</span> <span class="cn">TRUE</span>,<span class="at">top_n =</span> <span class="dv">15</span>,<span class="at">left_margin =</span> <span class="dv">30</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Freqency"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-freq-all" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-freq-all-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.4: Feature importance using Frequency</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>selected_features <span class="ot">&lt;-</span> importance_matrix_grp <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                      dplyr<span class="sc">::</span><span class="fu">select</span>(Feature) <span class="sc">|&gt;</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"BankName"</span>, Feature)) <span class="sc">|&gt;</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">top_n</span>(<span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Feature=</span><span class="st">"Qtr"</span>) <span class="sc">|&gt;</span> <span class="fu">as.list</span>()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>cv_param <span class="ot">&lt;-</span> <span class="fu">get_cv_params</span>()</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>model_select <span class="ot">&lt;-</span> <span class="fu">setup_train_test</span>(estimation_data, selected_features<span class="sc">$</span>Feature)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">run_xgb.caret.cv</span>(model_select<span class="sc">$</span>train.predictors, model_select<span class="sc">$</span>train.outcome, cv_param<span class="sc">$</span>n_folds, cv_param<span class="sc">$</span>n_repeats, <span class="at">model_name=</span> <span class="st">"model_select"</span>, <span class="at">method =</span> <span class="st">"xgbTree"</span>, cv_param<span class="sc">$</span>seeds)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>params_select <span class="ot">&lt;-</span> <span class="fu">read_csv</span> (<span class="st">"data/results/xgbTree_best_tune_model_select.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> <span class="fu">as.list</span>()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">run_validation</span>(model_select, params_select,<span class="st">"model_select"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="estimated-fit" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="estimated-fit"><span class="header-section-number">9.5</span> Estimated Fit</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>params_select <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/results/xgbTree_best_tune_model_select.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> <span class="fu">as.list</span>()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>predictor_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(model_select<span class="sc">$</span>train)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>est_data <span class="ot">&lt;-</span> estimation_data <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="fu">all_of</span>(predictor_cols)))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the data to matrix and assign output variable</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>estimate.outcome <span class="ot">&lt;-</span> est_data<span class="sc">$</span>UBPRE524.diff</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>estimate.predictors <span class="ot">&lt;-</span> <span class="fu">sparse.model.matrix</span>(UBPRE524.diff <span class="sc">~</span> .<span class="sc">-</span><span class="dv">1</span>, <span class="at">data =</span> est_data)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the matrix objects to DMatrix objects</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>dEst <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(estimate.predictors, <span class="at">label =</span> estimate.outcome)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">booster =</span> <span class="st">"gbtree"</span>, <span class="at">data =</span> dEst, <span class="at">params=</span> params_select, <span class="at">nrounds=</span>params_select<span class="sc">$</span>nrounds)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimation fit</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>est_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, dEst)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>bank_results <span class="ot">&lt;-</span> estimation_data <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">.fitted =</span> est_predictions,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">.resid =</span> UBPRE524.diff <span class="sc">-</span> est_predictions) <span class="sc">|&gt;</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">select</span>(Quarter, BankName, BankType,UBPRE524.diff,.fitted,.resid) </span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>bank_results <span class="sc">|&gt;</span> </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BankName <span class="sc">%in%</span> observation_data<span class="sc">$</span>BankName) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>.resid) <span class="sc">|&gt;</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">where</span>(is.numeric))<span class="sc">|&gt;</span> </span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Quarter, <span class="at">y =</span> value, <span class="at">color=</span>name)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="sc">~</span>BankType<span class="sc">+</span>BankName, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">".fitted"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, </span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">UBPRE524.diff =</span> <span class="st">"darkgrey"</span>)) <span class="sc">+</span> </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>(), <span class="at">legend.direction =</span> <span class="st">"vertical"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-plot-fit-xgboost" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-plot-fit-xgboost-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.5: Fitted vs.&nbsp;Observed for estimation data on sub-set of firms for model using <em>Selected Features</em></figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="shapley" class="level2" data-number="9.6">
<h2 data-number="9.6" class="anchored" data-anchor-id="shapley"><span class="header-section-number">9.6</span> Shapley</h2>
<p>Shapley additive explanations (SHAP) provide insights into how each feature influences the models predictions. Its commonly used to interpret predictions rather than regularisation <span class="citation" data-cites="Holzinger2022">(<a href="references.html#ref-Holzinger2022" role="doc-biblioref">Holzinger et al. 2022</a>)</span>. SHAP values can be averaged to assess overall feature importance across a dataset, while waterfall plots detail the feature contributions. Generally you would look at SHAP values for specific predictions, here we have averaged SHAP values for the training and test datasets.</p>
<div class="tabset-margin-container"></div><div id="fig-xgboost-shap" class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Feature Importance - Test</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Feature Importance - Training</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false">Waterfall - Test</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-4" role="tab" aria-controls="tabset-4-4" aria-selected="false">Waterfall - Training</a></li></ul>
<div id="fig-xgboost-shap" class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_test_imp_wo_group.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Test data all features</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_test_imp_model_select.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Test data selected features</figcaption>
</figure>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_train_imp_wo_group.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Training data all features</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_train_imp_model_select.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Training data selected features</figcaption>
</figure>
</div>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_test_water_wo_group.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Test data all features</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_test_water_model_select.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Test data selected features</figcaption>
</figure>
</div>
</div>
<div id="tabset-4-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-4-tab">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_train_water_wo_group.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Training data all features</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/xgb_train_water_model_select.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Training data selected features</figcaption>
</figure>
</div>
</div>
</div>
</div>
<section id="sec-residual-check-xgboost" class="level3" data-number="9.6.1">
<h3 data-number="9.6.1" class="anchored" data-anchor-id="sec-residual-check-xgboost"><span class="header-section-number">9.6.1</span> Residual diagnostics</h3>
<p>XGBoost, as with other machine learning models, do not make assumptions about the distribution of residuals. But it is still worth inspecting the residuals to assess whether the model is adequately capturing the underlying patterns in the data. As discussed in <a href="#sec-xgboost-data"><span>Section&nbsp;9.1</span></a> the feature <em>Qtr</em> was added as the ACF plots were showing distinct seasonal patterns. Though improved, the ACF still show seasonality for some banks.</p>
<div class="tabset-margin-container"></div><div id="panel-xgboost-checks" class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">CITIBANK</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">SYNCHRONY</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-3" role="tab" aria-controls="tabset-5-3" aria-selected="false">BARCLAYS</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-4" role="tab" aria-controls="tabset-5-4" aria-selected="false">AMERICAN EXPRESS</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-5" role="tab" aria-controls="tabset-5-5" aria-selected="false">CAPITAL ONE</a></li></ul>
<div id="panel-xgboost-checks" class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>bank <span class="ot">&lt;-</span> <span class="st">"CITIBANK"</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_bank_residual</span>(bank, bank_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-res-citi-xgboost" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-res-citi-xgboost-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.6: XGBoost residuals</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>bank <span class="ot">&lt;-</span> <span class="st">"SYNCHRONY"</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_bank_residual</span>(bank, bank_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-res-sync-xgboost" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-res-sync-xgboost-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.7: Best Bank Model residuals</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-3-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>bank <span class="ot">&lt;-</span> <span class="st">"BARCLAYS"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_bank_residual</span>(bank, bank_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-res-bar-xgboost" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-res-bar-xgboost-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.8: Model residuals</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-4-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>bank <span class="ot">&lt;-</span> <span class="st">"AMERICAN EXPRESS"</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_bank_residual</span>(bank, bank_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-res-ae-xgboost" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-res-ae-xgboost-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.9: Model residuals</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-5-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-5-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>bank <span class="ot">&lt;-</span>  <span class="st">"CAPITAL ONE"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_bank_residual</span>(bank, bank_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-res-cap-xgboost" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-res-cap-xgboost-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.10: Model residuals</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="prediction" class="level2" data-number="9.7">
<h2 data-number="9.7" class="anchored" data-anchor-id="prediction"><span class="header-section-number">9.7</span> Prediction</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>observation.outcome <span class="ot">&lt;-</span> observation_data<span class="sc">$</span>UBPRE524.diff</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>observation.predictors <span class="ot">&lt;-</span> <span class="fu">sparse.model.matrix</span>(UBPRE524.diff <span class="sc">~</span> .<span class="sc">-</span><span class="dv">1</span>, <span class="at">data =</span> observation_data  <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(predictor_cols)))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>dObs <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(observation.predictors, <span class="at">label =</span> observation.outcome)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, dObs)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>result_obs <span class="ot">&lt;-</span> observation_data <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">prediction =</span> predictions)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">map2</span>(partner_banks<span class="sc">$</span>Bank, partner_banks<span class="sc">$</span>Partner,map_prediction_to_partner, result_obs, all_data) <span class="sc">|&gt;</span> <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span> <span class="fu">add_column</span>(<span class="at">.model =</span> <span class="st">"Selected Features"</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="fu">map2</span>(partner_banks<span class="sc">$</span>Bank, partner_banks<span class="sc">$</span>Partner, plot_prediction, result, all_data) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-pred-observed-xgboost-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-pred-observed-xgboost-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.11: Prediction vs.&nbsp;Observed Event</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-pred-observed-xgboost-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-pred-observed-xgboost-2.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.12: Prediction vs.&nbsp;Observed Event</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-pred-observed-xgboost-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-pred-observed-xgboost-3.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.13: Prediction vs.&nbsp;Observed Event</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-pred-observed-xgboost-4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-pred-observed-xgboost-4.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.14: Prediction vs.&nbsp;Observed Event</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-pred-observed-xgboost-5" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-pred-observed-xgboost-5.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.15: Prediction vs.&nbsp;Observed Event</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-pred-observed-xgboost-6" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="model_ml_files/figure-html/fig-pred-observed-xgboost-6.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;9.16: Prediction vs.&nbsp;Observed Event</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="abnormal-results" class="level2" data-number="9.8">
<h2 data-number="9.8" class="anchored" data-anchor-id="abnormal-results"><span class="header-section-number">9.8</span> Abnormal Results</h2>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"Costco"</span>, <span class="st">"AMERICAN EXPRESS NATIONAL BANK (1394676)"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"Costco"</span>, <span class="st">"CITIBANK, N.A. (476810)"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"Walmart"</span>, <span class="st">"SYNCHRONY BANK (1216022)"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"Walmart"</span>, <span class="st">"CAPITAL ONE, NATIONAL ASSOCIATION (112837)"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"GAP"</span>, <span class="st">"SYNCHRONY BANK (1216022)"</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"GAP"</span>, <span class="st">"BARCLAYS BANK DELAWARE (2980209)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-abnormal-xgboost" class="cell tbl-parent quarto-layout-panel anchored">
<div class="panel-caption table-caption">
<p>Table&nbsp;9.5: Credit Card Plans-30-89 DAYS P/D %: Abnormal Returns (original scale)</p>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-abnormal-xgboost-1" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-abnormal-xgboost" style="flex-basis: 100.0%;justify-content: center;">

<div data-pagedtable="false"> <div class="table-caption">(a) <p>Costco (Old) - AMERICAN EXPRESS NATIONAL BANK (1394676)</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Period"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["observed"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["predicted"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["AR"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Cumulative Mean AR"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Cumulative AR"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"0.62","3":"0.69","4":"-0.07","5":"-0.07","6":"-0.07"},{"1":"2","2":"0.74","3":"0.81","4":"-0.07","5":"-0.07","6":"-0.14"},{"1":"3","2":"0.71","3":"0.82","4":"-0.11","5":"-0.08","6":"-0.25"},{"1":"4","2":"0.78","3":"0.74","4":"0.04","5":"-0.05","6":"-0.21"},{"1":"5","2":"0.74","3":"0.79","4":"-0.05","5":"-0.05","6":"-0.25"},{"1":"6","2":"0.82","3":"0.93","4":"-0.11","5":"-0.06","6":"-0.36"},{"1":"7","2":"0.69","3":"0.87","4":"-0.18","5":"-0.08","6":"-0.54"},{"1":"8","2":"0.69","3":"0.79","4":"-0.10","5":"-0.08","6":"-0.65"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[16],"max":[16]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-abnormal-xgboost-2" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-abnormal-xgboost" style="flex-basis: 100.0%;justify-content: center;">

<div data-pagedtable="false"> <div class="table-caption">(b) <p>Costco (New) - CITIBANK, N.A. (476810)</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Period"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["observed"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["predicted"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["AR"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Cumulative Mean AR"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Cumulative AR"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"1.09","3":"1.19","4":"-0.10","5":"-0.10","6":"-0.10"},{"1":"2","2":"1.20","3":"1.28","4":"-0.08","5":"-0.09","6":"-0.18"},{"1":"3","2":"1.12","3":"1.28","4":"-0.16","5":"-0.11","6":"-0.34"},{"1":"4","2":"1.09","3":"1.24","4":"-0.15","5":"-0.12","6":"-0.49"},{"1":"5","2":"1.08","3":"1.22","4":"-0.14","5":"-0.13","6":"-0.63"},{"1":"6","2":"1.19","3":"1.31","4":"-0.12","5":"-0.13","6":"-0.75"},{"1":"7","2":"1.11","3":"1.24","4":"-0.13","5":"-0.13","6":"-0.88"},{"1":"8","2":"1.14","3":"1.14","4":"0.00","5":"-0.11","6":"-0.88"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[16],"max":[16]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-abnormal-xgboost-3" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-abnormal-xgboost" style="flex-basis: 100.0%;justify-content: center;">

<div data-pagedtable="false"> <div class="table-caption">(c) <p>Walmart (Old) - SYNCHRONY BANK (1216022)</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Period"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["observed"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["predicted"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["AR"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Cumulative Mean AR"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Cumulative AR"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"2.61","3":"2.53","4":"0.08","5":"0.08","6":"0.08"},{"1":"2","2":"2.39","3":"2.56","4":"-0.17","5":"-0.04","6":"-0.09"},{"1":"3","2":"2.22","3":"2.52","4":"-0.30","5":"-0.13","6":"-0.38"},{"1":"4","2":"1.39","3":"2.15","4":"-0.76","5":"-0.29","6":"-1.15"},{"1":"5","2":"1.50","3":"2.31","4":"-0.81","5":"-0.39","6":"-1.96"},{"1":"6","2":"1.75","3":"2.39","4":"-0.64","5":"-0.43","6":"-2.60"},{"1":"7","2":"1.35","3":"2.10","4":"-0.75","5":"-0.48","6":"-3.35"},{"1":"8","2":"1.15","3":"2.10","4":"-0.95","5":"-0.54","6":"-4.30"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[16],"max":[16]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-abnormal-xgboost-4" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-abnormal-xgboost" style="flex-basis: 100.0%;justify-content: center;">

<div data-pagedtable="false"> <div class="table-caption">(d) <p>Walmart (New) - CAPITAL ONE, NATIONAL ASSOCIATION (112837)</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Period"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["observed"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["predicted"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["AR"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Cumulative Mean AR"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Cumulative AR"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"2.12","3":"2.09","4":"0.03","5":"0.03","6":"0.03"},{"1":"2","2":"2.62","3":"2.11","4":"0.51","5":"0.27","6":"0.55"},{"1":"3","2":"2.35","3":"2.18","4":"0.17","5":"0.24","6":"0.72"},{"1":"4","2":"1.73","3":"1.96","4":"-0.23","5":"0.12","6":"0.49"},{"1":"5","2":"1.56","3":"1.94","4":"-0.38","5":"0.02","6":"0.11"},{"1":"6","2":"1.56","3":"1.99","4":"-0.43","5":"-0.05","6":"-0.32"},{"1":"7","2":"1.32","3":"1.77","4":"-0.45","5":"-0.11","6":"-0.78"},{"1":"8","2":"1.16","3":"1.62","4":"-0.46","5":"-0.15","6":"-1.24"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[16],"max":[16]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-abnormal-xgboost-5" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-abnormal-xgboost" style="flex-basis: 100.0%;justify-content: center;">

<div data-pagedtable="false"> <div class="table-caption">(e) <p>GAP (Old) - SYNCHRONY BANK (1216022)</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Period"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["observed"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["predicted"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["AR"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Cumulative Mean AR"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Cumulative AR"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"1.57","3":"1.55","4":"0.02","5":"0.02","6":"0.02"},{"1":"2","2":"1.90","3":"1.78","4":"0.12","5":"0.07","6":"0.14"},{"1":"3","2":"2.01","3":"1.80","4":"0.21","5":"0.12","6":"0.35"},{"1":"4","2":"1.98","3":"1.69","4":"0.29","5":"0.16","6":"0.64"},{"1":"5","2":"2.13","3":"1.79","4":"0.34","5":"0.20","6":"0.98"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[16],"max":[16]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div id="tbl-abnormal-xgboost-6" class="quarto-layout-cell quarto-layout-cell-subref anchored" data-ref-parent="tbl-abnormal-xgboost" style="flex-basis: 100.0%;justify-content: center;">

<div data-pagedtable="false"> <div class="table-caption">(f) <p>GAP (New) - BARCLAYS BANK DELAWARE (2980209)</p> </div>
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Period"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["observed"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["predicted"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["AR"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Cumulative Mean AR"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Cumulative AR"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"0.69","3":"0.79","4":"-0.10","5":"-0.10","6":"-0.10"},{"1":"2","2":"1.14","3":"1.03","4":"0.11","5":"0.01","6":"0.01"},{"1":"3","2":"1.05","3":"1.05","4":"0.00","5":"0.01","6":"0.02"},{"1":"4","2":"1.09","3":"0.93","4":"0.16","5":"0.04","6":"0.18"},{"1":"5","2":"1.13","3":"1.01","4":"0.12","5":"0.06","6":"0.30"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[16],"max":[16]},"pages":{}}}
  </script>
</div>
</div>
</div>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-Holzinger2022" class="csl-entry" role="listitem">
Holzinger, A., R. Goebel, R. Fong, T. Moon, K.-R. Mller, and W. Samek. 2022. <span>General Pitfalls of Model-Agnostic Interpretation Methods for Machine Learning Models.</span> In <em>XxAI - Beyond Explainable AI</em>. Springer International Publishing AG. <a href="https://doi.org/10.1007/978-3-031-04083-2_4">https://doi.org/10.1007/978-3-031-04083-2_4</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./model_hierarchy_event.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Hierarchical Model</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./model_event_summary.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Overall Results</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb20" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "XGBoost Model"</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> html</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Preparation {#sec-xgboost-data}</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"functions.R"</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(shapviz)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>target_label <span class="ot">&lt;-</span> <span class="fu">credit_card.target_label</span>()</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>run_xgb.cv <span class="ot">&lt;-</span> <span class="cf">function</span>(dtrain) {</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  param_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">eta =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>),</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_depth =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>),</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">gamma =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.1</span>,<span class="fl">0.2</span>),</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">colsample_bytree =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.8</span>),</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_child_weight =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>),</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subsample =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.75</span>),</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Placeholder for cross-validation results</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  cv_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(param_grid))) {</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">booster =</span> <span class="st">"gbtree"</span>,</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">eta =</span> param_grid<span class="sc">$</span>eta[i],</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_depth =</span> param_grid<span class="sc">$</span>max_depth[i],</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">subsample =</span> param_grid<span class="sc">$</span>subsample[i],</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">colsample_bytree =</span> param_grid<span class="sc">$</span>colsample_bytree[i],</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_child_weight =</span> param_grid<span class="sc">$</span>min_child_weight[i],</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> param_grid<span class="sc">$</span>alpha[i],</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">lambda =</span> param_grid<span class="sc">$</span>lambda[i],</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">objective =</span> <span class="st">"reg:squarederror"</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    cv <span class="ot">&lt;-</span> <span class="fu">xgb.cv</span>(<span class="at">params =</span> params, <span class="at">data =</span> dtrain, <span class="at">nrounds =</span> <span class="dv">100</span>, <span class="at">nfold =</span> <span class="dv">5</span>, <span class="at">early_stopping_rounds =</span> <span class="dv">10</span>)</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    cv_results[[i]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">params =</span> params, <span class="at">cv_metrics =</span> cv)</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>  best_score <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>  best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(cv_results)) {</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    score <span class="ot">&lt;-</span> <span class="fu">min</span>(cv_results[[i]]<span class="sc">$</span>cv_metrics<span class="sc">$</span>evaluation_log)</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(score <span class="sc">&lt;</span> best_score) {</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>      best_score <span class="ot">&lt;-</span> score</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>      best_model <span class="ot">&lt;-</span> cv_results[[i]]</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>  best_model<span class="sc">$</span>cv_metrics[<span class="dv">4</span>]<span class="sc">$</span>evaluation_log <span class="sc">|&gt;</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(<span class="st">"data/results/xgboost_cv_metrics.csv"</span>)</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>  best_model<span class="sc">$</span>params <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(<span class="st">"data/results/xgboost_cv_params.csv"</span>)</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>run_xgb.caret.cv <span class="ot">&lt;-</span> <span class="cf">function</span>(train.predictors, train.outcome, n_folds, n_repeats, model_name, <span class="at">method =</span> <span class="st">"xgbTree"</span>, seeds) {</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"xgbTree"</span>) {</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">eta =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>),</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>                        <span class="at">max_depth =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>),</span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>                        <span class="at">gamma =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>),</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>                        <span class="at">colsample_bytree =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.8</span>),</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>                        <span class="at">min_child_weight =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>),</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>                        <span class="at">subsample =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.75</span>),</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nrounds =</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">150</span>,<span class="dv">200</span>)</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">eta =</span> <span class="fl">0.01</span>,</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>                        <span class="at">alpha =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>                        <span class="at">lambda =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">50</span>),</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nrounds =</span> <span class="dv">100</span></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>  control <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"repeatedcv"</span>, <span class="at">number =</span> n_folds, <span class="at">repeats =</span> n_repeats, <span class="at">seeds =</span> seeds)</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Train the model</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">train</span>(train.predictors, train.outcome,</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> method,</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>                <span class="at">trControl =</span> control,</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>                <span class="at">tuneGrid =</span> grid,</span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>                <span class="at">metric =</span> <span class="st">"RMSE"</span>)</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the plot</span></span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="fu">glue</span>(<span class="st">"data/results/{method}_tuning_plot_{model_name}.png"</span>), <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>)</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(model)</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>() </span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>  <span class="co">#save tuning results</span></span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>results  <span class="sc">|&gt;</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(<span class="fu">glue</span>(<span class="st">"data/results/{method}_tuning_results_{model_name}.csv"</span>))</span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>  model<span class="sc">$</span>bestTune <span class="sc">|&gt;</span> readr<span class="sc">::</span><span class="fu">write_csv</span>(<span class="fu">glue</span>(<span class="st">"data/results/{method}_best_tune_{model_name}.csv"</span>))</span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xgb.save</span>(<span class="at">model =</span> model<span class="sc">$</span>finalModel, <span class="at">fname =</span> <span class="fu">glue</span>(<span class="st">"data/results/best_{method}_{model_name}.model"</span>))</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the number of folds and repeats</span></span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>get_cv_params <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>  n_folds <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>  n_repeats <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>  seeds <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(n_folds <span class="sc">*</span> n_repeats), <span class="cf">function</span>(x) <span class="fu">sample.int</span>(<span class="dv">1000</span>, <span class="dv">144</span>))</span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>  seeds[[<span class="fu">length</span>(seeds) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="dv">1000</span>, <span class="dv">1</span>)  <span class="co"># The last seed for the final model</span></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">n_folds =</span> n_folds, <span class="at">n_repeats =</span> n_repeats, <span class="at">seeds =</span> seeds)</span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>bank_fit_result <span class="ot">&lt;-</span> <span class="cf">function</span>(bankname, data, <span class="at">train_test =</span> <span class="st">"Train"</span>, <span class="at">target_name =</span> <span class="st">"UBPRE524.diff"</span>) {</span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>    X_filtered <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(BankName <span class="sc">==</span> bankname) <span class="sc">|&gt;</span> <span class="fu">pull</span>(predictions)</span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>    Y_filtered <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(BankName <span class="sc">==</span> bankname) <span class="sc">|&gt;</span> <span class="fu">pull</span>(target_name)</span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>    caret<span class="sc">::</span><span class="fu">postResample</span>(<span class="at">pred =</span> X_filtered, <span class="at">obs =</span> Y_filtered) <span class="sc">|&gt;</span> <span class="fu">t</span>() <span class="sc">|&gt;</span><span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_column</span>(<span class="at">BankName =</span> bankname,</span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a>                 <span class="at">.type =</span> train_test) <span class="sc">|&gt;</span> <span class="fu">relocate</span>(BankName,.type)</span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"metrics error for {bankname}: {e}"</span>))</span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a>run_validation <span class="ot">&lt;-</span> <span class="cf">function</span>(model, params, model_name) {</span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">booster =</span> <span class="st">"gbtree"</span>, <span class="at">data =</span> model<span class="sc">$</span>dtrain, <span class="at">params=</span> params, <span class="at">nrounds=</span>params<span class="sc">$</span>nrounds)</span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a>  bank_types <span class="ot">&lt;-</span>  model<span class="sc">$</span>train <span class="sc">|&gt;</span> <span class="fu">distinct</span>(BankName, BankType)</span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Training fit</span></span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a>  train_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, model<span class="sc">$</span>dtrain)</span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># See Fit on unseen data: Generate Predictions</span></span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a>  test_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, model<span class="sc">$</span>dtest)</span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a>  train_result <span class="ot">&lt;-</span> model<span class="sc">$</span>train <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">predictions =</span> train_predictions)</span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a>  test_result <span class="ot">&lt;-</span> model<span class="sc">$</span>test <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">predictions =</span> test_predictions)</span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a>  results_est <span class="ot">&lt;-</span> <span class="fu">unique</span>(model<span class="sc">$</span>train<span class="sc">$</span>BankName) <span class="sc">|&gt;</span> </span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">map</span>(bank_fit_result,train_result, <span class="st">"Train"</span>) <span class="sc">|&gt;</span> <span class="fu">list_rbind</span>()</span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a>  results_test <span class="ot">&lt;-</span> <span class="fu">unique</span>(model<span class="sc">$</span>train<span class="sc">$</span>BankName) <span class="sc">|&gt;</span> </span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">map</span>(bank_fit_result,test_result, <span class="st">"Test"</span>) <span class="sc">|&gt;</span> <span class="fu">list_rbind</span>()</span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb20-148"><a href="#cb20-148" aria-hidden="true" tabindex="-1"></a>  comb <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_est, results_test) <span class="sc">|&gt;</span> <span class="fu">left_join</span>(bank_types, <span class="at">by =</span> <span class="fu">join_by</span>(BankName)) <span class="sc">|&gt;</span></span>
<span id="cb20-149"><a href="#cb20-149" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(BankName, BankType, .type, RMSE, MAE, Rsquared)</span>
<span id="cb20-150"><a href="#cb20-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-151"><a href="#cb20-151" aria-hidden="true" tabindex="-1"></a>  comb <span class="sc">|&gt;</span> <span class="fu">write_csv</span>(<span class="fu">glue</span>(<span class="st">"data/results/xgbTree_validation_{model_name}.csv"</span>))  </span>
<span id="cb20-152"><a href="#cb20-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-153"><a href="#cb20-153" aria-hidden="true" tabindex="-1"></a>  importance_matrix  <span class="ot">&lt;-</span> <span class="fu">xgb.importance</span>(<span class="fu">names</span>(model<span class="sc">$</span>dtrain), <span class="at">model =</span> m)</span>
<span id="cb20-154"><a href="#cb20-154" aria-hidden="true" tabindex="-1"></a>  importance_matrix <span class="sc">|&gt;</span> <span class="fu">write_csv</span>(<span class="fu">glue</span>(<span class="st">"data/results/xgbTree_importmatrix_{model_name}.csv"</span>)) </span>
<span id="cb20-155"><a href="#cb20-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-156"><a href="#cb20-156" aria-hidden="true" tabindex="-1"></a>  <span class="co">#save images</span></span>
<span id="cb20-157"><a href="#cb20-157" aria-hidden="true" tabindex="-1"></a>  shap_train <span class="ot">&lt;-</span> <span class="fu">shapviz</span>(m,<span class="at">X_pred =</span> model<span class="sc">$</span>dtrain,<span class="at">X=</span><span class="fu">data.matrix</span>(model<span class="sc">$</span>train.predictors))</span>
<span id="cb20-158"><a href="#cb20-158" aria-hidden="true" tabindex="-1"></a>  shap_test <span class="ot">&lt;-</span> <span class="fu">shapviz</span>(m,<span class="at">X_pred =</span> model<span class="sc">$</span>dtest,<span class="at">X=</span><span class="fu">data.matrix</span>(model<span class="sc">$</span>test.predictors))</span>
<span id="cb20-159"><a href="#cb20-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-160"><a href="#cb20-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="fu">glue</span>(<span class="st">"images/xgb_train_imp_{model_name}.png"</span>), <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>)</span>
<span id="cb20-161"><a href="#cb20-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sv_importance</span>(shap_train, <span class="at">kind =</span> <span class="st">"beeswarm"</span>, <span class="at">show_numbers =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-162"><a href="#cb20-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb20-163"><a href="#cb20-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-164"><a href="#cb20-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="fu">glue</span>(<span class="st">"images/xgb_test_imp_{model_name}.png"</span>), <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>)</span>
<span id="cb20-165"><a href="#cb20-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sv_importance</span>(shap_test, <span class="at">kind =</span> <span class="st">"beeswarm"</span>, <span class="at">show_numbers =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-166"><a href="#cb20-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb20-167"><a href="#cb20-167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-168"><a href="#cb20-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="fu">glue</span>(<span class="st">"images/xgb_train_water_{model_name}.png"</span>), <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>)</span>
<span id="cb20-169"><a href="#cb20-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sv_waterfall</span>(shap_train)</span>
<span id="cb20-170"><a href="#cb20-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb20-171"><a href="#cb20-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-172"><a href="#cb20-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="fu">glue</span>(<span class="st">"images/xgb_test_water_{model_name}.png"</span>), <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>)</span>
<span id="cb20-173"><a href="#cb20-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sv_waterfall</span>(shap_test)</span>
<span id="cb20-174"><a href="#cb20-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb20-175"><a href="#cb20-175" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-176"><a href="#cb20-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-177"><a href="#cb20-177" aria-hidden="true" tabindex="-1"></a>map_prediction_to_partner <span class="ot">&lt;-</span> <span class="cf">function</span>(Bank, Partner, obs_data_w_qtr, all_data) {</span>
<span id="cb20-178"><a href="#cb20-178" aria-hidden="true" tabindex="-1"></a>  event_data <span class="ot">&lt;-</span> obs_data_w_qtr <span class="sc">|&gt;</span> </span>
<span id="cb20-179"><a href="#cb20-179" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">filter</span>(BankName <span class="sc">==</span> Bank) <span class="sc">|&gt;</span> </span>
<span id="cb20-180"><a href="#cb20-180" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">as.name</span>(Partner) <span class="sc">&gt;=</span><span class="dv">0</span>) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">8</span>) </span>
<span id="cb20-181"><a href="#cb20-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-182"><a href="#cb20-182" aria-hidden="true" tabindex="-1"></a>  min_qtr <span class="ot">&lt;-</span> event_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(Quarter <span class="sc">==</span> <span class="fu">min</span>(Quarter)) <span class="sc">|&gt;</span> <span class="fu">pull</span>(Quarter)</span>
<span id="cb20-183"><a href="#cb20-183" aria-hidden="true" tabindex="-1"></a>  value0 <span class="ot">&lt;-</span> all_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(BankName <span class="sc">==</span> Bank, Quarter <span class="sc">==</span> (min_qtr <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> <span class="fu">pull</span>(UBPRE524.Value)</span>
<span id="cb20-184"><a href="#cb20-184" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-185"><a href="#cb20-185" aria-hidden="true" tabindex="-1"></a>  event_data <span class="sc">|&gt;</span> </span>
<span id="cb20-186"><a href="#cb20-186" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">observed =</span> UBPRE524.Value, <span class="at">predicted =</span> value0 <span class="sc">+</span> <span class="fu">cumsum</span>(prediction))<span class="sc">|&gt;</span> </span>
<span id="cb20-187"><a href="#cb20-187" aria-hidden="true" tabindex="-1"></a>      <span class="fu">add_column</span>(<span class="at">Partner =</span> Partner)</span>
<span id="cb20-188"><a href="#cb20-188" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-189"><a href="#cb20-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-190"><a href="#cb20-190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-191"><a href="#cb20-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-192"><a href="#cb20-192" aria-hidden="true" tabindex="-1"></a>In our previous models, we utilised a panel dataset that captured temporal dynamics. However, machine learning algorithms require a dataset structured to reflect a single timeframe. Consequently, we need to transform our panel data into a cross-sectional format.</span>
<span id="cb20-193"><a href="#cb20-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-194"><a href="#cb20-194" aria-hidden="true" tabindex="-1"></a>This entailed:</span>
<span id="cb20-195"><a href="#cb20-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-196"><a href="#cb20-196" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Removing time-related factor 'Quarter' (for example, '2020 Q1').</span>
<span id="cb20-197"><a href="#cb20-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-198"><a href="#cb20-198" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Excluding lagged values of the <span class="in">`r target_label`</span> to prevent look-ahead bias. This ensures that our model does not inadvertently learn from future information which could result in overfitting.</span>
<span id="cb20-199"><a href="#cb20-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-200"><a href="#cb20-200" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Excluding variables that are close proxies for <span class="in">`r target_label`</span>, as listed in @tbl-xgboost-bias. These variables are closely tied to the target variable as they reflect ongoing delinquency beyond a 30-day period. This means that the model can indirectly learn future information which could result in overfitting.</span>
<span id="cb20-201"><a href="#cb20-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-204"><a href="#cb20-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-205"><a href="#cb20-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-206"><a href="#cb20-206" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-xgboost-bias</span></span>
<span id="cb20-207"><a href="#cb20-207" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Removed 'proxy' features"</span></span>
<span id="cb20-208"><a href="#cb20-208" aria-hidden="true" tabindex="-1"></a><span class="fu">get_ubpr_labels</span>() <span class="sc">|&gt;</span></span>
<span id="cb20-209"><a href="#cb20-209" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(Code <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"UBPRE411"</span>, <span class="st">"UBPRE523"</span>, <span class="st">"UBPRE521"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb20-210"><a href="#cb20-210" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Code, <span class="at">Description =</span> Desc) <span class="sc">|&gt;</span></span>
<span id="cb20-211"><a href="#cb20-211" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">format =</span> <span class="st">"html"</span>)</span>
<span id="cb20-212"><a href="#cb20-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-213"><a href="#cb20-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-216"><a href="#cb20-216" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-217"><a href="#cb20-217" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-218"><a href="#cb20-218" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">get_model_data</span>()</span>
<span id="cb20-219"><a href="#cb20-219" aria-hidden="true" tabindex="-1"></a>all_data <span class="ot">&lt;-</span> model_data<span class="sc">$</span>all_data <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()           </span>
<span id="cb20-220"><a href="#cb20-220" aria-hidden="true" tabindex="-1"></a>partner_banks <span class="ot">&lt;-</span> <span class="fu">credit_card.partnerships.long</span>()</span>
<span id="cb20-221"><a href="#cb20-221" aria-hidden="true" tabindex="-1"></a>estimation_data <span class="ot">&lt;-</span> model_data<span class="sc">$</span>estimation_data</span>
<span id="cb20-222"><a href="#cb20-222" aria-hidden="true" tabindex="-1"></a>observation_data <span class="ot">&lt;-</span> model_data<span class="sc">$</span>observation_data</span>
<span id="cb20-223"><a href="#cb20-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-224"><a href="#cb20-224" aria-hidden="true" tabindex="-1"></a>log_cols_wo_group <span class="ot">&lt;-</span> all_data <span class="sc">|&gt;</span></span>
<span id="cb20-225"><a href="#cb20-225" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">".log.diff"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb20-226"><a href="#cb20-226" aria-hidden="true" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"UBPRE524.log.diff"</span>), </span>
<span id="cb20-227"><a href="#cb20-227" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">starts_with</span>(<span class="st">"UBPRE524.group"</span>), </span>
<span id="cb20-228"><a href="#cb20-228" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">starts_with</span>(<span class="st">"UBPRE524.all"</span>)))  <span class="sc">|&gt;</span> <span class="fu">names</span>() </span>
<span id="cb20-229"><a href="#cb20-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-230"><a href="#cb20-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-231"><a href="#cb20-231" aria-hidden="true" tabindex="-1"></a>setup_train_test <span class="ot">&lt;-</span> <span class="cf">function</span>(estimation_data, predictor_cols) {</span>
<span id="cb20-232"><a href="#cb20-232" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> estimation_data <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb20-233"><a href="#cb20-233" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(UBPRE524.diff, BankName, BankType, <span class="fu">all_of</span>(predictor_cols), Qtr))  </span>
<span id="cb20-234"><a href="#cb20-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-235"><a href="#cb20-235" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(data<span class="sc">$</span>UBPRE524.diff, <span class="at">p =</span> <span class="fl">0.70</span>, <span class="at">list=</span><span class="cn">FALSE</span>)</span>
<span id="cb20-236"><a href="#cb20-236" aria-hidden="true" tabindex="-1"></a>  training <span class="ot">&lt;-</span> data[s,]</span>
<span id="cb20-237"><a href="#cb20-237" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> data[<span class="sc">-</span>s,]</span>
<span id="cb20-238"><a href="#cb20-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-239"><a href="#cb20-239" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the data to matrix and assign output variable</span></span>
<span id="cb20-240"><a href="#cb20-240" aria-hidden="true" tabindex="-1"></a>  train.outcome <span class="ot">&lt;-</span> training<span class="sc">$</span>UBPRE524.diff</span>
<span id="cb20-241"><a href="#cb20-241" aria-hidden="true" tabindex="-1"></a>  train.predictors <span class="ot">&lt;-</span> <span class="fu">sparse.model.matrix</span>(UBPRE524.diff <span class="sc">~</span> .<span class="sc">-</span><span class="dv">1</span>, <span class="at">data =</span> training)</span>
<span id="cb20-242"><a href="#cb20-242" aria-hidden="true" tabindex="-1"></a>  test.outcome <span class="ot">&lt;-</span> test<span class="sc">$</span>UBPRE524.diff</span>
<span id="cb20-243"><a href="#cb20-243" aria-hidden="true" tabindex="-1"></a>  test.predictors <span class="ot">&lt;-</span> <span class="fu">sparse.model.matrix</span>(UBPRE524.diff <span class="sc">~</span> .<span class="sc">-</span><span class="dv">1</span>, <span class="at">data =</span> test)</span>
<span id="cb20-244"><a href="#cb20-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-245"><a href="#cb20-245" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the matrix objects to DMatrix objects</span></span>
<span id="cb20-246"><a href="#cb20-246" aria-hidden="true" tabindex="-1"></a>  dtrain <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(train.predictors, <span class="at">label =</span> train.outcome)</span>
<span id="cb20-247"><a href="#cb20-247" aria-hidden="true" tabindex="-1"></a>  dtest <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(test.predictors, <span class="at">label =</span> test.outcome)</span>
<span id="cb20-248"><a href="#cb20-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-249"><a href="#cb20-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">train =</span> training, <span class="at">test =</span> test, <span class="at">dtrain =</span> dtrain, <span class="at">dtest =</span> dtest, <span class="at">train.predictors =</span> train.predictors, </span>
<span id="cb20-250"><a href="#cb20-250" aria-hidden="true" tabindex="-1"></a>       <span class="at">test.predictors =</span> test.predictors, <span class="at">train.outcome =</span> train.outcome, <span class="at">test.outcome =</span> test.outcome)</span>
<span id="cb20-251"><a href="#cb20-251" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-252"><a href="#cb20-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-253"><a href="#cb20-253" aria-hidden="true" tabindex="-1"></a>model_without_group <span class="ot">&lt;-</span> <span class="fu">setup_train_test</span>(estimation_data, log_cols_wo_group)</span>
<span id="cb20-254"><a href="#cb20-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-255"><a href="#cb20-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-256"><a href="#cb20-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-259"><a href="#cb20-259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-260"><a href="#cb20-260" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-261"><a href="#cb20-261" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb20-262"><a href="#cb20-262" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-263"><a href="#cb20-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-264"><a href="#cb20-264" aria-hidden="true" tabindex="-1"></a>cv_param <span class="ot">&lt;-</span> <span class="fu">get_cv_params</span>()</span>
<span id="cb20-265"><a href="#cb20-265" aria-hidden="true" tabindex="-1"></a><span class="fu">run_xgb.caret.cv</span>(model_without_group<span class="sc">$</span>train.predictors, model_without_group<span class="sc">$</span>train.outcome, cv_param<span class="sc">$</span>n_folds, cv_param<span class="sc">$</span>n_repeats, <span class="at">model_name=</span><span class="st">"model_without_group"</span>, <span class="at">method =</span> <span class="st">"xgbTree"</span>, cv_param<span class="sc">$</span>seeds)</span>
<span id="cb20-266"><a href="#cb20-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-267"><a href="#cb20-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-268"><a href="#cb20-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-269"><a href="#cb20-269" aria-hidden="true" tabindex="-1"></a>3 datasets were tested:</span>
<span id="cb20-270"><a href="#cb20-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-271"><a href="#cb20-271" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>*All data* - note group <span class="in">`r target_label`</span> features removed.</span>
<span id="cb20-272"><a href="#cb20-272" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>*Selected features*. To see if a simpler model would generalise better on unseen test data, a dataset of the top 10 important features from the *All data* model was selected (see @sec-xgboost-feature).</span>
<span id="cb20-273"><a href="#cb20-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-274"><a href="#cb20-274" aria-hidden="true" tabindex="-1"></a>Furthermore, the seasonal factor *Qtr* (ranging from 1 to 4) was added to all datasets. Initial model testing revealed distinct seasonal trends in the residuals, as identified in the Autocorrelation Function (ACF) plots. Introducing *Qtr* attempts to help the model account for these seasonal patterns. An alternative approach could have involved de-seasonalising the data.</span>
<span id="cb20-275"><a href="#cb20-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-276"><a href="#cb20-276" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Hyperparameter Tuning</span></span>
<span id="cb20-277"><a href="#cb20-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-278"><a href="#cb20-278" aria-hidden="true" tabindex="-1"></a>In XGBoost we can tune the model hyperparameters e.g., maximum tree depth, to regularise the model so it does not overfit the training data.</span>
<span id="cb20-279"><a href="#cb20-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-280"><a href="#cb20-280" aria-hidden="true" tabindex="-1"></a>We use Cross Validation to explore the hyperparameter space. This process helps identify the combination of parameters that best balance between overfitting (by avoiding too high variance) and underfitting (by avoiding too high bias).</span>
<span id="cb20-281"><a href="#cb20-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-282"><a href="#cb20-282" aria-hidden="true" tabindex="-1"></a>We used 5-Fold Cross-Validation, repeated 3 times - each time with a different random division of the dataset into 5 folds. This means cross validation was performed a total of 15 train-test splits (3 repeats  5 folds) to get an overall performance estimate.</span>
<span id="cb20-283"><a href="#cb20-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-284"><a href="#cb20-284" aria-hidden="true" tabindex="-1"></a>We can see from @fig-xgcv-wo-group that changes to the ETA hyperparameter, in particular, impacted the RMSE metric. ETA (value between 0 and 1) determines the weight of each tree's contribution to the final model. A smaller ETA means making smaller updates so the model is less likely to make large adjustments based on any single observation or pattern in the data i.e. it reduces the impact of outliers or noise. An eta of 0.1 for all datasets (see @tbl-xgboost-param) was selected. </span>
<span id="cb20-285"><a href="#cb20-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-286"><a href="#cb20-286" aria-hidden="true" tabindex="-1"></a>::: {#panel-xgtuning .panel-tabset}</span>
<span id="cb20-287"><a href="#cb20-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-288"><a href="#cb20-288" aria-hidden="true" tabindex="-1"></a><span class="fu">###  All Data</span></span>
<span id="cb20-289"><a href="#cb20-289" aria-hidden="true" tabindex="-1"></a><span class="al">![Parameter Tuning for model without group features](images/xgbTree_tuning_plot_model_without_group.png)</span>{#fig-xgcv-wo-group}</span>
<span id="cb20-290"><a href="#cb20-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-291"><a href="#cb20-291" aria-hidden="true" tabindex="-1"></a><span class="fu">### Selected Features</span></span>
<span id="cb20-292"><a href="#cb20-292" aria-hidden="true" tabindex="-1"></a><span class="al">![Parameter Tuning for model with selected features](images/xgbTree_tuning_plot_model_select.png)</span>{#fig-xgcv-selected}</span>
<span id="cb20-293"><a href="#cb20-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-294"><a href="#cb20-294" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb20-295"><a href="#cb20-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-298"><a href="#cb20-298" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-299"><a href="#cb20-299" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-300"><a href="#cb20-300" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-xgboost-param</span></span>
<span id="cb20-301"><a href="#cb20-301" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: Optimal tuning model parameters for each dataset</span></span>
<span id="cb20-302"><a href="#cb20-302" aria-hidden="true" tabindex="-1"></a>params_wo_group <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/results/xgbTree_best_tune_model_without_group.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-303"><a href="#cb20-303" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">add_column</span>(<span class="at">model =</span> <span class="st">"All Data"</span>) <span class="sc">|&gt;</span> <span class="fu">as.list</span>()</span>
<span id="cb20-304"><a href="#cb20-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-305"><a href="#cb20-305" aria-hidden="true" tabindex="-1"></a>params_select_group <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/results/xgbTree_best_tune_model_select.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-306"><a href="#cb20-306" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">add_column</span>(<span class="at">model =</span> <span class="st">"Selected"</span>) <span class="sc">|&gt;</span> <span class="fu">as.list</span>()</span>
<span id="cb20-307"><a href="#cb20-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-308"><a href="#cb20-308" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(params_wo_group,params_select_group) <span class="sc">|&gt;</span> </span>
<span id="cb20-309"><a href="#cb20-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="sc">-</span>model)) <span class="sc">|&gt;</span></span>
<span id="cb20-310"><a href="#cb20-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from=</span><span class="fu">c</span>(model)) <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()  </span>
<span id="cb20-311"><a href="#cb20-311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-312"><a href="#cb20-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-313"><a href="#cb20-313" aria-hidden="true" tabindex="-1"></a><span class="fu">## Train/Test Split Validation</span></span>
<span id="cb20-314"><a href="#cb20-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-317"><a href="#cb20-317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-318"><a href="#cb20-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-319"><a href="#cb20-319" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb20-320"><a href="#cb20-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-321"><a href="#cb20-321" aria-hidden="true" tabindex="-1"></a><span class="fu">run_validation</span>(model_without_group, params_wo_group,<span class="st">"wo_group"</span>)</span>
<span id="cb20-322"><a href="#cb20-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-323"><a href="#cb20-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-324"><a href="#cb20-324" aria-hidden="true" tabindex="-1"></a>The *Selected Feature* dataset across all banks (@tbl-xgtest-select) performed well and had the least discrepancy in our metrics.</span>
<span id="cb20-325"><a href="#cb20-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-326"><a href="#cb20-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-327"><a href="#cb20-327" aria-hidden="true" tabindex="-1"></a>::: {#panel-xgboost-test .panel-tabset}</span>
<span id="cb20-328"><a href="#cb20-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-329"><a href="#cb20-329" aria-hidden="true" tabindex="-1"></a><span class="fu">### All Data</span></span>
<span id="cb20-332"><a href="#cb20-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-333"><a href="#cb20-333" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-334"><a href="#cb20-334" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-xgtest-group</span></span>
<span id="cb20-335"><a href="#cb20-335" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: Comparing Accuracy Metrics for Training and Test data#| </span></span>
<span id="cb20-336"><a href="#cb20-336" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-subcap:</span></span>
<span id="cb20-337"><a href="#cb20-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "Accuracy Metrics on Training and Test data for sub-set of banks"</span></span>
<span id="cb20-338"><a href="#cb20-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "Mean Accuracy Metrics for our sub-set of banks"</span></span>
<span id="cb20-339"><a href="#cb20-339" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "Mean Accuracy Metrics across all banks"</span></span>
<span id="cb20-340"><a href="#cb20-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-341"><a href="#cb20-341" aria-hidden="true" tabindex="-1"></a>banks <span class="ot">=</span> <span class="fu">unique</span>(observation_data<span class="sc">$</span>BankName)</span>
<span id="cb20-342"><a href="#cb20-342" aria-hidden="true" tabindex="-1"></a>val_wo_results <span class="ot">&lt;-</span> <span class="fu">get_summary_validation.xgboost</span>(<span class="st">"wo_group"</span>, banks)</span>
<span id="cb20-343"><a href="#cb20-343" aria-hidden="true" tabindex="-1"></a>val_wo_results<span class="sc">$</span>tbl1 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span>
<span id="cb20-344"><a href="#cb20-344" aria-hidden="true" tabindex="-1"></a>val_wo_results<span class="sc">$</span>tbl2 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span>
<span id="cb20-345"><a href="#cb20-345" aria-hidden="true" tabindex="-1"></a>val_wo_results<span class="sc">$</span>tbl3 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span>
<span id="cb20-346"><a href="#cb20-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-347"><a href="#cb20-347" aria-hidden="true" tabindex="-1"></a><span class="fu">### Selected Features</span></span>
<span id="cb20-348"><a href="#cb20-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-351"><a href="#cb20-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-352"><a href="#cb20-352" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-353"><a href="#cb20-353" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-xgtest-select</span></span>
<span id="cb20-354"><a href="#cb20-354" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: Comparing Accuracy Metrics for Training and Test data</span></span>
<span id="cb20-355"><a href="#cb20-355" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-subcap:</span></span>
<span id="cb20-356"><a href="#cb20-356" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "Accuracy Metrics on Training and Test data for sub-set of banks"</span></span>
<span id="cb20-357"><a href="#cb20-357" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "Mean Accuracy Metrics for our sub-set of banks"</span></span>
<span id="cb20-358"><a href="#cb20-358" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "Mean Accuracy Metrics across all banks"</span></span>
<span id="cb20-359"><a href="#cb20-359" aria-hidden="true" tabindex="-1"></a>val_results <span class="ot">&lt;-</span> <span class="fu">get_summary_validation.xgboost</span>(<span class="st">"model_select"</span>, banks)</span>
<span id="cb20-360"><a href="#cb20-360" aria-hidden="true" tabindex="-1"></a>val_results<span class="sc">$</span>tbl1 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span>
<span id="cb20-361"><a href="#cb20-361" aria-hidden="true" tabindex="-1"></a>val_results<span class="sc">$</span>tbl2 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span>
<span id="cb20-362"><a href="#cb20-362" aria-hidden="true" tabindex="-1"></a>val_results<span class="sc">$</span>tbl3 <span class="sc">|&gt;</span> rmarkdown<span class="sc">::</span><span class="fu">paged_table</span>()</span>
<span id="cb20-363"><a href="#cb20-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-364"><a href="#cb20-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-365"><a href="#cb20-365" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb20-366"><a href="#cb20-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-367"><a href="#cb20-367" aria-hidden="true" tabindex="-1"></a><span class="fu">## Feature Selection {#sec-xgboost-feature}</span></span>
<span id="cb20-368"><a href="#cb20-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-369"><a href="#cb20-369" aria-hidden="true" tabindex="-1"></a>The plots below show the Gain (the improvement in accuracy the model gains from including a feature) and Frequency (how often each feature is split on across all boosting tree) of each feature relative to the first feature.</span>
<span id="cb20-370"><a href="#cb20-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-371"><a href="#cb20-371" aria-hidden="true" tabindex="-1"></a>Model uses Household Debt Ratio (TDSP). Generally, portfolio features like *Unused Commitments on Credit Cards* were more important than exogenous economic measures.</span>
<span id="cb20-372"><a href="#cb20-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-373"><a href="#cb20-373" aria-hidden="true" tabindex="-1"></a>::: {#fig-xgboost-importance .panel-tabset}</span>
<span id="cb20-374"><a href="#cb20-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-375"><a href="#cb20-375" aria-hidden="true" tabindex="-1"></a><span class="fu">### All Data - Gain</span></span>
<span id="cb20-376"><a href="#cb20-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-379"><a href="#cb20-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-380"><a href="#cb20-380" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb20-381"><a href="#cb20-381" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-gain-all</span></span>
<span id="cb20-382"><a href="#cb20-382" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Feature importance using Gain </span></span>
<span id="cb20-383"><a href="#cb20-383" aria-hidden="true" tabindex="-1"></a>importance_matrix_grp <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/results/xgbTree_importmatrix_wo_group.csv"</span>,<span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-384"><a href="#cb20-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-385"><a href="#cb20-385" aria-hidden="true" tabindex="-1"></a>feature_desc <span class="ot">&lt;-</span> <span class="fu">get_feature_labels</span>()</span>
<span id="cb20-386"><a href="#cb20-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-387"><a href="#cb20-387" aria-hidden="true" tabindex="-1"></a>importance_matrix_lab <span class="ot">&lt;-</span> importance_matrix_grp <span class="sc">|&gt;</span> </span>
<span id="cb20-388"><a href="#cb20-388" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">mutate</span>(<span class="at">Code =</span> stringr<span class="sc">::</span><span class="fu">str_split_i</span>(Feature,<span class="st">"</span><span class="sc">\\</span><span class="st">."</span>,<span class="dv">1</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb20-389"><a href="#cb20-389" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">left_join</span>(feature_desc,<span class="at">by =</span> <span class="fu">join_by</span>(Code)) <span class="sc">|&gt;</span> </span>
<span id="cb20-390"><a href="#cb20-390" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">mutate</span>(<span class="at">Feature =</span> <span class="fu">paste</span>(Feature, <span class="fu">coalesce</span>(Desc,<span class="st">""</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)) <span class="sc">|&gt;</span> <span class="fu">data.table</span>()</span>
<span id="cb20-391"><a href="#cb20-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-392"><a href="#cb20-392" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.plot.importance</span>(importance_matrix_lab, <span class="at">measure =</span> <span class="st">"Gain"</span>, <span class="at">xlab =</span> <span class="st">"Relative importance"</span>,<span class="at">top_n =</span> <span class="dv">15</span>,<span class="at">left_margin =</span> <span class="dv">30</span>,<span class="at">rel_to_first =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-393"><a href="#cb20-393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-394"><a href="#cb20-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-395"><a href="#cb20-395" aria-hidden="true" tabindex="-1"></a><span class="fu">### All Data - Frequency</span></span>
<span id="cb20-396"><a href="#cb20-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-399"><a href="#cb20-399" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-400"><a href="#cb20-400" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-401"><a href="#cb20-401" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb20-402"><a href="#cb20-402" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-freq-all</span></span>
<span id="cb20-403"><a href="#cb20-403" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Feature importance using Frequency </span></span>
<span id="cb20-404"><a href="#cb20-404" aria-hidden="true" tabindex="-1"></a><span class="fu">xgb.ggplot.importance</span>(importance_matrix_lab, <span class="at">measure =</span> <span class="st">"Frequency"</span>, <span class="at">rel_to_first =</span> <span class="cn">TRUE</span>,<span class="at">top_n =</span> <span class="dv">15</span>,<span class="at">left_margin =</span> <span class="dv">30</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Freqency"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb20-405"><a href="#cb20-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-406"><a href="#cb20-406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-407"><a href="#cb20-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-408"><a href="#cb20-408" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb20-409"><a href="#cb20-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-412"><a href="#cb20-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-413"><a href="#cb20-413" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-414"><a href="#cb20-414" aria-hidden="true" tabindex="-1"></a>selected_features <span class="ot">&lt;-</span> importance_matrix_grp <span class="sc">|&gt;</span> </span>
<span id="cb20-415"><a href="#cb20-415" aria-hidden="true" tabindex="-1"></a>                      dplyr<span class="sc">::</span><span class="fu">select</span>(Feature) <span class="sc">|&gt;</span> </span>
<span id="cb20-416"><a href="#cb20-416" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"BankName"</span>, Feature)) <span class="sc">|&gt;</span> </span>
<span id="cb20-417"><a href="#cb20-417" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">top_n</span>(<span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">add_row</span>(<span class="at">Feature=</span><span class="st">"Qtr"</span>) <span class="sc">|&gt;</span> <span class="fu">as.list</span>()</span>
<span id="cb20-418"><a href="#cb20-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-419"><a href="#cb20-419" aria-hidden="true" tabindex="-1"></a>cv_param <span class="ot">&lt;-</span> <span class="fu">get_cv_params</span>()</span>
<span id="cb20-420"><a href="#cb20-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-421"><a href="#cb20-421" aria-hidden="true" tabindex="-1"></a>model_select <span class="ot">&lt;-</span> <span class="fu">setup_train_test</span>(estimation_data, selected_features<span class="sc">$</span>Feature)</span>
<span id="cb20-422"><a href="#cb20-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-425"><a href="#cb20-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-426"><a href="#cb20-426" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-427"><a href="#cb20-427" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-428"><a href="#cb20-428" aria-hidden="true" tabindex="-1"></a><span class="fu">run_xgb.caret.cv</span>(model_select<span class="sc">$</span>train.predictors, model_select<span class="sc">$</span>train.outcome, cv_param<span class="sc">$</span>n_folds, cv_param<span class="sc">$</span>n_repeats, <span class="at">model_name=</span> <span class="st">"model_select"</span>, <span class="at">method =</span> <span class="st">"xgbTree"</span>, cv_param<span class="sc">$</span>seeds)</span>
<span id="cb20-429"><a href="#cb20-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-430"><a href="#cb20-430" aria-hidden="true" tabindex="-1"></a>params_select <span class="ot">&lt;-</span> <span class="fu">read_csv</span> (<span class="st">"data/results/xgbTree_best_tune_model_select.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> <span class="fu">as.list</span>()</span>
<span id="cb20-431"><a href="#cb20-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-432"><a href="#cb20-432" aria-hidden="true" tabindex="-1"></a><span class="fu">run_validation</span>(model_select, params_select,<span class="st">"model_select"</span>)</span>
<span id="cb20-433"><a href="#cb20-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-434"><a href="#cb20-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-435"><a href="#cb20-435" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estimated Fit</span></span>
<span id="cb20-438"><a href="#cb20-438" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-439"><a href="#cb20-439" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-440"><a href="#cb20-440" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb20-441"><a href="#cb20-441" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-keep: all</span></span>
<span id="cb20-442"><a href="#cb20-442" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-plot-fit-xgboost</span></span>
<span id="cb20-443"><a href="#cb20-443" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Fitted vs. Observed for estimation data on sub-set of firms for model using *Selected Features*"</span></span>
<span id="cb20-444"><a href="#cb20-444" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb20-445"><a href="#cb20-445" aria-hidden="true" tabindex="-1"></a>params_select <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/results/xgbTree_best_tune_model_select.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> <span class="fu">as.list</span>()</span>
<span id="cb20-446"><a href="#cb20-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-447"><a href="#cb20-447" aria-hidden="true" tabindex="-1"></a>predictor_cols <span class="ot">&lt;-</span> <span class="fu">names</span>(model_select<span class="sc">$</span>train)</span>
<span id="cb20-448"><a href="#cb20-448" aria-hidden="true" tabindex="-1"></a>est_data <span class="ot">&lt;-</span> estimation_data <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="fu">all_of</span>(predictor_cols)))</span>
<span id="cb20-449"><a href="#cb20-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-450"><a href="#cb20-450" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the data to matrix and assign output variable</span></span>
<span id="cb20-451"><a href="#cb20-451" aria-hidden="true" tabindex="-1"></a>estimate.outcome <span class="ot">&lt;-</span> est_data<span class="sc">$</span>UBPRE524.diff</span>
<span id="cb20-452"><a href="#cb20-452" aria-hidden="true" tabindex="-1"></a>estimate.predictors <span class="ot">&lt;-</span> <span class="fu">sparse.model.matrix</span>(UBPRE524.diff <span class="sc">~</span> .<span class="sc">-</span><span class="dv">1</span>, <span class="at">data =</span> est_data)</span>
<span id="cb20-453"><a href="#cb20-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-454"><a href="#cb20-454" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the matrix objects to DMatrix objects</span></span>
<span id="cb20-455"><a href="#cb20-455" aria-hidden="true" tabindex="-1"></a>dEst <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(estimate.predictors, <span class="at">label =</span> estimate.outcome)</span>
<span id="cb20-456"><a href="#cb20-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-457"><a href="#cb20-457" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">xgboost</span>(<span class="at">booster =</span> <span class="st">"gbtree"</span>, <span class="at">data =</span> dEst, <span class="at">params=</span> params_select, <span class="at">nrounds=</span>params_select<span class="sc">$</span>nrounds)</span>
<span id="cb20-458"><a href="#cb20-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-459"><a href="#cb20-459" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimation fit</span></span>
<span id="cb20-460"><a href="#cb20-460" aria-hidden="true" tabindex="-1"></a>est_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, dEst)</span>
<span id="cb20-461"><a href="#cb20-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-462"><a href="#cb20-462" aria-hidden="true" tabindex="-1"></a>bank_results <span class="ot">&lt;-</span> estimation_data <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">.fitted =</span> est_predictions,</span>
<span id="cb20-463"><a href="#cb20-463" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">.resid =</span> UBPRE524.diff <span class="sc">-</span> est_predictions) <span class="sc">|&gt;</span></span>
<span id="cb20-464"><a href="#cb20-464" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">select</span>(Quarter, BankName, BankType,UBPRE524.diff,.fitted,.resid) </span>
<span id="cb20-465"><a href="#cb20-465" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb20-466"><a href="#cb20-466" aria-hidden="true" tabindex="-1"></a>bank_results <span class="sc">|&gt;</span> </span>
<span id="cb20-467"><a href="#cb20-467" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BankName <span class="sc">%in%</span> observation_data<span class="sc">$</span>BankName) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>.resid) <span class="sc">|&gt;</span></span>
<span id="cb20-468"><a href="#cb20-468" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">where</span>(is.numeric))<span class="sc">|&gt;</span> </span>
<span id="cb20-469"><a href="#cb20-469" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Quarter, <span class="at">y =</span> value, <span class="at">color=</span>name)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb20-470"><a href="#cb20-470" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="sc">~</span>BankType<span class="sc">+</span>BankName, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb20-471"><a href="#cb20-471" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">".fitted"</span> <span class="ot">=</span> <span class="st">"#D55E00"</span>, </span>
<span id="cb20-472"><a href="#cb20-472" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">UBPRE524.diff =</span> <span class="st">"darkgrey"</span>)) <span class="sc">+</span> </span>
<span id="cb20-473"><a href="#cb20-473" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>, <span class="at">legend.title =</span> <span class="fu">element_blank</span>(), <span class="at">legend.direction =</span> <span class="st">"vertical"</span>)</span>
<span id="cb20-474"><a href="#cb20-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-475"><a href="#cb20-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-476"><a href="#cb20-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-477"><a href="#cb20-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-478"><a href="#cb20-478" aria-hidden="true" tabindex="-1"></a><span class="fu">## Shapley</span></span>
<span id="cb20-479"><a href="#cb20-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-480"><a href="#cb20-480" aria-hidden="true" tabindex="-1"></a>Shapley additive explanations (SHAP) provide insights into how each feature influences the model's predictions. It's commonly used to interpret  predictions rather than regularisation <span class="co">[</span><span class="ot">@Holzinger2022</span><span class="co">]</span>. SHAP values can be averaged to assess overall feature importance across a dataset, while waterfall plots detail the feature contributions. Generally you would look at SHAP values for specific predictions, here we have averaged SHAP values for the training and test datasets.</span>
<span id="cb20-481"><a href="#cb20-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-482"><a href="#cb20-482" aria-hidden="true" tabindex="-1"></a>::: {#fig-xgboost-shap .panel-tabset}</span>
<span id="cb20-483"><a href="#cb20-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-484"><a href="#cb20-484" aria-hidden="true" tabindex="-1"></a><span class="fu">## Feature Importance - Test </span></span>
<span id="cb20-485"><a href="#cb20-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-486"><a href="#cb20-486" aria-hidden="true" tabindex="-1"></a><span class="al">![Test data all features](images/xgb_test_imp_wo_group.png)</span></span>
<span id="cb20-487"><a href="#cb20-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-488"><a href="#cb20-488" aria-hidden="true" tabindex="-1"></a><span class="al">![Test data selected features](images/xgb_test_imp_model_select.png)</span></span>
<span id="cb20-489"><a href="#cb20-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-490"><a href="#cb20-490" aria-hidden="true" tabindex="-1"></a><span class="fu">## Feature Importance - Training</span></span>
<span id="cb20-491"><a href="#cb20-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-492"><a href="#cb20-492" aria-hidden="true" tabindex="-1"></a><span class="al">![Training data all features](images/xgb_train_imp_wo_group.png)</span></span>
<span id="cb20-493"><a href="#cb20-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-494"><a href="#cb20-494" aria-hidden="true" tabindex="-1"></a><span class="al">![Training data selected features](images/xgb_train_imp_model_select.png)</span></span>
<span id="cb20-495"><a href="#cb20-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-496"><a href="#cb20-496" aria-hidden="true" tabindex="-1"></a><span class="fu">## Waterfall - Test</span></span>
<span id="cb20-497"><a href="#cb20-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-498"><a href="#cb20-498" aria-hidden="true" tabindex="-1"></a><span class="al">![Test data all features](images/xgb_test_water_wo_group.png)</span></span>
<span id="cb20-499"><a href="#cb20-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-500"><a href="#cb20-500" aria-hidden="true" tabindex="-1"></a><span class="al">![Test data selected features](images/xgb_test_water_model_select.png)</span></span>
<span id="cb20-501"><a href="#cb20-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-502"><a href="#cb20-502" aria-hidden="true" tabindex="-1"></a><span class="fu">## Waterfall - Training</span></span>
<span id="cb20-503"><a href="#cb20-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-504"><a href="#cb20-504" aria-hidden="true" tabindex="-1"></a><span class="al">![Training data all features](images/xgb_train_water_wo_group.png)</span></span>
<span id="cb20-505"><a href="#cb20-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-506"><a href="#cb20-506" aria-hidden="true" tabindex="-1"></a><span class="al">![Training data selected features](images/xgb_train_water_model_select.png)</span></span>
<span id="cb20-507"><a href="#cb20-507" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb20-508"><a href="#cb20-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-509"><a href="#cb20-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-510"><a href="#cb20-510" aria-hidden="true" tabindex="-1"></a><span class="fu">### Residual diagnostics {#sec-residual-check-xgboost}</span></span>
<span id="cb20-511"><a href="#cb20-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-512"><a href="#cb20-512" aria-hidden="true" tabindex="-1"></a>XGBoost, as with other machine learning models, do not make assumptions about the distribution of residuals. But it is still worth inspecting the residuals to assess whether the model is adequately capturing the underlying patterns in the data. As discussed in @sec-xgboost-data the feature *Qtr* was added as the ACF plots were showing distinct seasonal patterns. Though improved, the ACF still show seasonality for some banks.</span>
<span id="cb20-513"><a href="#cb20-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-514"><a href="#cb20-514" aria-hidden="true" tabindex="-1"></a>::: {#panel-xgboost-checks .panel-tabset}</span>
<span id="cb20-515"><a href="#cb20-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-516"><a href="#cb20-516" aria-hidden="true" tabindex="-1"></a><span class="fu">### CITIBANK</span></span>
<span id="cb20-519"><a href="#cb20-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-520"><a href="#cb20-520" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-521"><a href="#cb20-521" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-res-citi-xgboost</span></span>
<span id="cb20-522"><a href="#cb20-522" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "XGBoost residuals"</span></span>
<span id="cb20-523"><a href="#cb20-523" aria-hidden="true" tabindex="-1"></a>bank <span class="ot">&lt;-</span> <span class="st">"CITIBANK"</span></span>
<span id="cb20-524"><a href="#cb20-524" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_bank_residual</span>(bank, bank_results)</span>
<span id="cb20-525"><a href="#cb20-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-526"><a href="#cb20-526" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-527"><a href="#cb20-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-528"><a href="#cb20-528" aria-hidden="true" tabindex="-1"></a><span class="fu">### SYNCHRONY</span></span>
<span id="cb20-531"><a href="#cb20-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-532"><a href="#cb20-532" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-533"><a href="#cb20-533" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-res-sync-xgboost</span></span>
<span id="cb20-534"><a href="#cb20-534" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Best Bank Model residuals"</span></span>
<span id="cb20-535"><a href="#cb20-535" aria-hidden="true" tabindex="-1"></a>bank <span class="ot">&lt;-</span> <span class="st">"SYNCHRONY"</span></span>
<span id="cb20-536"><a href="#cb20-536" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_bank_residual</span>(bank, bank_results)</span>
<span id="cb20-537"><a href="#cb20-537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-538"><a href="#cb20-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-539"><a href="#cb20-539" aria-hidden="true" tabindex="-1"></a><span class="fu">### BARCLAYS</span></span>
<span id="cb20-542"><a href="#cb20-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-543"><a href="#cb20-543" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-544"><a href="#cb20-544" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-res-bar-xgboost</span></span>
<span id="cb20-545"><a href="#cb20-545" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Model residuals"</span></span>
<span id="cb20-546"><a href="#cb20-546" aria-hidden="true" tabindex="-1"></a>bank <span class="ot">&lt;-</span> <span class="st">"BARCLAYS"</span></span>
<span id="cb20-547"><a href="#cb20-547" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_bank_residual</span>(bank, bank_results)</span>
<span id="cb20-548"><a href="#cb20-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-549"><a href="#cb20-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-550"><a href="#cb20-550" aria-hidden="true" tabindex="-1"></a><span class="fu">### AMERICAN EXPRESS</span></span>
<span id="cb20-553"><a href="#cb20-553" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-554"><a href="#cb20-554" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-555"><a href="#cb20-555" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-res-ae-xgboost</span></span>
<span id="cb20-556"><a href="#cb20-556" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Model residuals"</span></span>
<span id="cb20-557"><a href="#cb20-557" aria-hidden="true" tabindex="-1"></a>bank <span class="ot">&lt;-</span> <span class="st">"AMERICAN EXPRESS"</span></span>
<span id="cb20-558"><a href="#cb20-558" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_bank_residual</span>(bank, bank_results)</span>
<span id="cb20-559"><a href="#cb20-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-560"><a href="#cb20-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-561"><a href="#cb20-561" aria-hidden="true" tabindex="-1"></a><span class="fu">### CAPITAL ONE</span></span>
<span id="cb20-562"><a href="#cb20-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-565"><a href="#cb20-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-566"><a href="#cb20-566" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-567"><a href="#cb20-567" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-res-cap-xgboost</span></span>
<span id="cb20-568"><a href="#cb20-568" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Model residuals"</span></span>
<span id="cb20-569"><a href="#cb20-569" aria-hidden="true" tabindex="-1"></a>bank <span class="ot">&lt;-</span>  <span class="st">"CAPITAL ONE"</span></span>
<span id="cb20-570"><a href="#cb20-570" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_bank_residual</span>(bank, bank_results)</span>
<span id="cb20-571"><a href="#cb20-571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-572"><a href="#cb20-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-573"><a href="#cb20-573" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb20-574"><a href="#cb20-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-575"><a href="#cb20-575" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prediction </span></span>
<span id="cb20-576"><a href="#cb20-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-579"><a href="#cb20-579" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-580"><a href="#cb20-580" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-581"><a href="#cb20-581" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb20-582"><a href="#cb20-582" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-keep: all</span></span>
<span id="cb20-583"><a href="#cb20-583" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pred-observed-xgboost</span></span>
<span id="cb20-584"><a href="#cb20-584" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Prediction vs. Observed Event"</span></span>
<span id="cb20-585"><a href="#cb20-585" aria-hidden="true" tabindex="-1"></a>observation.outcome <span class="ot">&lt;-</span> observation_data<span class="sc">$</span>UBPRE524.diff</span>
<span id="cb20-586"><a href="#cb20-586" aria-hidden="true" tabindex="-1"></a>observation.predictors <span class="ot">&lt;-</span> <span class="fu">sparse.model.matrix</span>(UBPRE524.diff <span class="sc">~</span> .<span class="sc">-</span><span class="dv">1</span>, <span class="at">data =</span> observation_data  <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(predictor_cols)))</span>
<span id="cb20-587"><a href="#cb20-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-588"><a href="#cb20-588" aria-hidden="true" tabindex="-1"></a>dObs <span class="ot">&lt;-</span> <span class="fu">xgb.DMatrix</span>(observation.predictors, <span class="at">label =</span> observation.outcome)</span>
<span id="cb20-589"><a href="#cb20-589" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, dObs)</span>
<span id="cb20-590"><a href="#cb20-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-591"><a href="#cb20-591" aria-hidden="true" tabindex="-1"></a>result_obs <span class="ot">&lt;-</span> observation_data <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">prediction =</span> predictions)</span>
<span id="cb20-592"><a href="#cb20-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-593"><a href="#cb20-593" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">map2</span>(partner_banks<span class="sc">$</span>Bank, partner_banks<span class="sc">$</span>Partner,map_prediction_to_partner, result_obs, all_data) <span class="sc">|&gt;</span> <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span> <span class="fu">add_column</span>(<span class="at">.model =</span> <span class="st">"Selected Features"</span>)</span>
<span id="cb20-594"><a href="#cb20-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-595"><a href="#cb20-595" aria-hidden="true" tabindex="-1"></a><span class="fu">map2</span>(partner_banks<span class="sc">$</span>Bank, partner_banks<span class="sc">$</span>Partner, plot_prediction, result, all_data) </span>
<span id="cb20-596"><a href="#cb20-596" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-597"><a href="#cb20-597" aria-hidden="true" tabindex="-1"></a><span class="fu">## Abnormal Results</span></span>
<span id="cb20-600"><a href="#cb20-600" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-601"><a href="#cb20-601" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb20-602"><a href="#cb20-602" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-abnormal-xgboost</span></span>
<span id="cb20-603"><a href="#cb20-603" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Credit Card Plans-30-89 DAYS P/D %: Abnormal Returns (original scale)"</span></span>
<span id="cb20-604"><a href="#cb20-604" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-subcap: </span></span>
<span id="cb20-605"><a href="#cb20-605" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "Costco (Old) - AMERICAN EXPRESS NATIONAL BANK (1394676)"</span></span>
<span id="cb20-606"><a href="#cb20-606" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "Costco (New) - CITIBANK, N.A. (476810)"</span></span>
<span id="cb20-607"><a href="#cb20-607" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "Walmart (Old) - SYNCHRONY BANK (1216022)"</span></span>
<span id="cb20-608"><a href="#cb20-608" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "Walmart (New) - CAPITAL ONE, NATIONAL ASSOCIATION (112837)"</span></span>
<span id="cb20-609"><a href="#cb20-609" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "GAP (Old) - SYNCHRONY BANK (1216022)"</span></span>
<span id="cb20-610"><a href="#cb20-610" aria-hidden="true" tabindex="-1"></a><span class="co">#| - "GAP (New) - BARCLAYS BANK DELAWARE (2980209)"</span></span>
<span id="cb20-611"><a href="#cb20-611" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"Costco"</span>, <span class="st">"AMERICAN EXPRESS NATIONAL BANK (1394676)"</span>)</span>
<span id="cb20-612"><a href="#cb20-612" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"Costco"</span>, <span class="st">"CITIBANK, N.A. (476810)"</span>)</span>
<span id="cb20-613"><a href="#cb20-613" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"Walmart"</span>, <span class="st">"SYNCHRONY BANK (1216022)"</span>)</span>
<span id="cb20-614"><a href="#cb20-614" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"Walmart"</span>, <span class="st">"CAPITAL ONE, NATIONAL ASSOCIATION (112837)"</span>)</span>
<span id="cb20-615"><a href="#cb20-615" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"GAP"</span>, <span class="st">"SYNCHRONY BANK (1216022)"</span>)</span>
<span id="cb20-616"><a href="#cb20-616" aria-hidden="true" tabindex="-1"></a><span class="fu">print_ar</span>(result, <span class="st">"GAP"</span>, <span class="st">"BARCLAYS BANK DELAWARE (2980209)"</span>)</span>
<span id="cb20-617"><a href="#cb20-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>