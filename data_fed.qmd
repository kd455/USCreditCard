```{r}
#| echo: false
#| warning: false
source('functions.R')
```
```{r}
#| echo: false
#| warning: false
us_measures <- us_economy() 
recessions <- us_economy.recession() |> 
                filter(Flag == 1, 
                       yearmonth(Month) >= yearmonth('1992-01-01'))

us_measures_scaled <- us_measures |>
                        mutate(B069RC1.Pop = B069RC1/POPTHM) |>
                        mutate(B069RC1.CPI = B069RC1.Pop/PCEPI) |>
                        mutate(across(!Month, scale))

confidence_postreg <- us_measures |> select(CSCICP03USM665S) |> 
                        mutate(Quarter = yearquarter(Month)) |>
                        filter_index(get_regulation_cutoff() ~ .) |>
                        index_by(Quarter) |>
                        summarise(mean_val = mean(CSCICP03USM665S)) 
                        
                        
confidence_postreg |> autoplot(mean_val) 



us_measures_scaled |> select(CSCICP03USM665S) |> View()
    na.omit() |>
    mutate(Quarter = yearquarter(Month)) |>
     index_by(Quarter) |> 
     filter_index(get_regulation_cutoff() ~ .) |> write.csv("monthly.xls")

us_measures_scaled |> select(CSCICP03USM665S) |>
    na.omit() |>
    filter_index("2010 Jun" ~ .) |> write.csv("quarterly.xls")

us_measures_scaled |> 
    na.omit() |>
    pivot_longer(cols = !Month) |>
    autoplot(value)+ facet_wrap(~ name, scales = "free_y" , ncol = 3) +
    theme(strip.text = element_text(size = 14), legend.position = "none") +
    labs(y = "Normalised (Normal=0)") 

us_measures_scaled |> 
    na.omit() |>
    select(PSAVERT,CSCICP03USM665S,B069RC1,B069RC1.CPI,UNRATE) |>
    pivot_longer(cols = !Month) |>
    autoplot()+ facet_wrap(~ name, scales = "free_y" , ncol = 1,labeller =  as_labeller(c(PSAVERT= "US Personal Savings Rate \n(PSAVERT)", 
    CSCICP03USM665S = "US Composite Confidence Indicator \n(CSCICP03USM665S)",
    B069RC1 = "US Personal interest payment \n(B069RC1)", 
    B069RC1.CPI = "US Personal interest payment per capita CPI Adjusted \n(B069RC1/POPTHM/CPIAUCSL)",
    UNRATE = "Unemployment Rate \n(UNRATE)"))) +
    labs(y = "Normalised (Normal=0)")+
    geom_rect(data = recessions,inherit.aes = FALSE, aes(xmin = Month, xmax = Month + 30, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = 0.5) +
    labs(title = "Macro Economic Measures (data series id)",
        subtitle = "grey areas indicate recessions",
        ) +theme_bw() +
    theme(legend.position = 'none',strip.text = element_text(size = 14)) +
    xlab("")
        
```

