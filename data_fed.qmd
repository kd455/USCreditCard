
```{r}
#| echo: false
#| warning: false
source('functions.R')
```
```{r}
#| echo: false
#| warning: false

#inflation
#https://aeturrell.github.io/coding-for-economists/time-series.html#adjusting-for-inflation
#PCEPI



us_measures <- us_economy() |>
                mutate(B069RC1.Pop = B069RC1/POPTHM) |>
                mutate(B069RC1.CPI = B069RC1.Pop/PCEPI) |> na.omit()

recessions <- us_economy.recession() |> 
                filter(Flag == 1, 
                       yearmonth(Month) >= yearmonth(as.Date('1992-01-01')))


overdue30to89 <- credit_card.overdue_3089(T) |> 
                   summarise(target_mean = mean(Value),
                    target_median = median(Value)) |> na.omit()

overdue30to89.lcbank <-  credit_card.overdue_3089(T) |> 
                        filter(BankType == "LargeCreditCardBank") |> 
                        summarise(target_mean = mean(Value),
                        target_median = median(Value)) |> na.omit()

overdue30to89.lbank <-  credit_card.overdue_3089(T) |> 
                        filter(BankType == "LargeBank") |> 
                        summarise(target_mean = mean(Value),
                        target_median = median(Value)) |> na.omit()                        

us_measures_scaled <- us_measures |>
                        mutate(across(!Month, scale))

us_measures_qtr <- us_measures |>
                    mutate(Quarter = yearquarter(Month)) |>
                    filter(Quarter >= yearquarter(get_regulation_cutoff())) |>
                    index_by(Quarter) |>
                    summarise(across(!Month, mean))


overdue30to89 |> pull(target_mean) |> tseries::adf.test(k=4)
tseries::adf.test(us_measures_qtr$CSCICP03USM665S, k=4)

######### % change 
us_measures_qtr_pctchange <- us_measures_qtr |> 
                                mutate(across(!Quarter, ~difference(.)/lag(.) *100))

overdue30to89_pctchange <- overdue30to89 |> group_by(BankType) |> mutate(across(!Quarter, ~difference(.)/lag(.) *100))

overdue30to89_pctchange |> na.omit() |> autoplot(target_median) + facet_wrap(~BankType)
us_measures_qtr_pctchange |> select(CSCICP03USM665S) |> autoplot()

######### % change 


granger_data |> 
    select(c("target_mean", "target_median", "CSCICP03USM665S")) |>
    pivot_longer(cols = where(is.numeric)) |>
    na.omit() |> 
    autoplot(value) + facet_wrap(~BankType) 

run_granger_test <- function(data, target_variable, exog_variable, order = 4) {
    if (is.numeric(data[[exog_variable]])) {
            grangertest(data[[target_variable]], data[[exog_variable]], order = order) |> as_tibble() |> na.omit() |> tibble::add_column(exog_variable)
    }
}

granger_data <- overdue30to89 |> left_join (us_measures_qtr,by = join_by(Quarter))

us_measures_qtr |> names() |>
        purrr::map(\(x) run_granger_test(overdue30to89 |> left_join (us_measures_qtr,by = join_by(Quarter)), "target_mean", x, 4)) |> list_rbind() |> arrange(`Pr(>F)`) |> slice_head(n=10)

us_measures_qtr |> names() |>
        purrr::map(\(x) run_granger_test(overdue30to89.lbank |> left_join (us_measures_qtr,by = join_by(Quarter)), "target_mean", x, 4)) |> list_rbind() |> arrange(`Pr(>F)`) |> slice_head(n=6)

us_measures_qtr |> names() |>
        purrr::map(\(x) run_granger_test(overdue30to89.lcbank |> left_join (us_measures_qtr,by = join_by(Quarter)), "target_mean", x, 4)) |> list_rbind() |> arrange(`Pr(>F)`)|> slice_head(n=5)
        




run_granger_test(granger_data,"target_median", "CSCICP03USM665S")  |>
    as_tibble() |> na.omit()

#https://davegiles.blogspot.com/2011/04/testing-for-granger-causality.html

us_measures_scaled |> 
    na.omit() |>
    pivot_longer(cols = !Month) |>
    autoplot(value)+ facet_wrap(~ name, scales = "free_y" , ncol = 3) +
    theme(strip.text = element_text(size = 14), legend.position = "none") +
    labs(y = "Normalised (Normal=0)") 

us_measures_scaled |> 
    na.omit() |>
    select(PSAVERT,CSCICP03USM665S,B069RC1,B069RC1.CPI,UNRATE) |>
    pivot_longer(cols = !Month) |>
    autoplot()+ facet_wrap(~ name, scales = "free_y" , ncol = 1,labeller =  as_labeller(c(PSAVERT= "US Personal Savings Rate \n(PSAVERT)", 
    CSCICP03USM665S = "US Composite Confidence Indicator \n(CSCICP03USM665S)",
    B069RC1 = "US Personal interest payment \n(B069RC1)", 
    B069RC1.CPI = "US Personal interest payment per capita CPI Adjusted \n(B069RC1/POPTHM/CPIAUCSL)",
    UNRATE = "Unemployment Rate \n(UNRATE)"))) +
    labs(y = "Normalised (Normal=0)")+
    geom_rect(data = recessions,inherit.aes = FALSE, aes(xmin = Month, xmax = Month + 30, ymin = -Inf, ymax = Inf), fill = "lightgrey", alpha = 0.5) +
    labs(title = "Macro Economic Measures (data series id)",
        subtitle = "grey areas indicate recessions",
        ) +
    theme(legend.position = 'none',strip.text = element_text(size = 14)) +
    xlab("")
        
```

