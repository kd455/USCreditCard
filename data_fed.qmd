---
title: "US Economic Data"
---

```{r}
#| echo: false
#| warning: false
source('functions.R')
```

As discussed in @sec-trend-event the impact of the partnership event can be masked by trends and seasonality.

The simplist model approach we look at is the Market model, see @sec-model-market, which involves adjusting each Bank's *`r credit_card.target_label()`* by removing the influence of the broader trend within its respective group (Large Banks or Large Credit Card Banks). We assume the residuals are due to the unique characteristics of each Bank's credit card portfolio. These characteristics might include the bank's specific credit policies, customer risk profiles, or portfolio management strategies.

This approach assumes that the broader "market" trend takes into account, to some extent, the impact of macroeconomic factors. However, we may want to include macroeconomic variables to improve the model's ability to explain credit card delinquencies that are not captured by the group trend alone.

US Federal Reserve Economic Data [@fred] provides macroeconomic data series; we can use past literature and new analysis to inform our choice of variables.

@Agarwal2003, using proprietary credit card data of 700 thousand customers from 1995 to 2001, concluded that *unemployment* is a key determinant of consumer delinquency and bankruptcy. @GHJ2001 pointed to *consumer debt ratio* i.e. when debt payment obligations become too high relative to disposable income for the population as a whole, borrowers are unable to service their debts. @taghiyeh2021 explored 19 lagged macroeconomic variables and found the most significant to predict credit card loss was: previous quarter *Unemployment*, *Building permits* and *Initial unemployment insurance claims*; previous year's (lag 4) *Money stock* and *ISM Purchasing Mangers Index* and the current quarter's *Weekly hours worked by manufacturing workers*.


```{r}
#| echo: false
#| warning: false
                
granger_test_permutations <- function(data, target_col_name = "value.mean", exog_names, max_lag = 4) {
    results <- list()
    for (lag in 1:max_lag) {
        results[[lag]] <- exog_names |>
                            purrr::map(\(x) run_granger_test(data, target_col_name, x, lag)) |> list_rbind() |> arrange(`Pr(>F)`) |> filter(`Pr(>F)` <= 0.05) |> mutate(across(F:`Pr(>F)`, ~ round(.,3))) |> select(-Res.Df)       
    } 
    results 
}    
us_measures_qtr <- us_economy.quarterly_selected() |> drop_na()

apply_bank_filters = TRUE
apply_reg_filter = FALSE
overdue30to89.all <- credit_card.overdue30to89.agg(apply_bank_filters, apply_reg_filter) 
overdue30to89.all.lcbank <- credit_card.overdue30to89.agg.lccbank(apply_bank_filters, apply_reg_filter)
overdue30to89.all.lbank <-  credit_card.overdue30to89.agg.lbank(apply_bank_filters, apply_reg_filter)

apply_reg_filter = TRUE  
overdue30to89.post <- credit_card.overdue30to89.agg(apply_bank_filters, apply_reg_filter)       
overdue30to89.post.lcbank <- credit_card.overdue30to89.agg.lccbank(apply_bank_filters, apply_reg_filter)
overdue30to89.post.lbank <-  credit_card.overdue30to89.agg.lbank(apply_bank_filters, apply_reg_filter)             

# library(corrplot)
# cor_data = overdue30to89.post.lbank |> left_join(us_measures_qtr) |> as_tibble() |> select(value_diff.group.mean, UNRATE:A229RC0.CPI)
# corrplot(cor(cor_data), method = "color", type = "upper", order = "hclust",
#          tl.col = "black", tl.srt = 45, 
#          addCoef.col = "black")
```

## US Economic Variables

The figures below plot data series related to consumer financial behaviour following the 2008 financial crisis and the enactment of the Credit Card Accountability Responsibility and Disclosure (CARD) Act in 2010 (see @sec-cardact). 

Each variable has been adjusted for population changes and inflation to ensure we can compare across different time periods.

In the decade that ensued post crisis, there is a noticeable trend of increasing personal expenditures and although personal incomes also increase, their rate of increase does not match that of expenditures. This divergence results in a gradual rise in the consumer debt service ratio (CDSP), indicating an expanding gap between income and debt obligations. Notably, throughout this period, credit card delinquency rates remain relatively stable, suggesting improved risk management practices. However, the onset of the COVID-19 pandemic marks a distinct phase of economic upheaval.

::: {#fig-usmeasures .panel-tabset}

## Combined
```{r}
#| warning: false
#| error: false

plot_us_category("Expenditures",us_measures_qtr, overdue30to89.all, "value.all.median")
plot_us_category("Income & Savings",us_measures_qtr, overdue30to89.all, "value.all.median")
plot_us_category("Debt",us_measures_qtr, overdue30to89.all, "value.all.median")
plot_us_category("Economy",us_measures_qtr, overdue30to89.all, "value.all.median")
```

## Large Bank
```{r}
#| warning: false
#| error: false

plot_us_category("Expenditures", us_measures_qtr, overdue30to89.all.lbank, "value.group.median")
plot_us_category("Income & Savings", us_measures_qtr, overdue30to89.all.lbank, "value.group.median")
plot_us_category("Debt", us_measures_qtr, overdue30to89.all.lbank, "value.group.median")
plot_us_category("Economy", us_measures_qtr, overdue30to89.all.lbank, "value.group.median")
```

## Large Credit Card Bank
```{r}
#| warning: false
#| error: false
plot_us_category("Expenditures", us_measures_qtr, overdue30to89.all.lcbank, "value.group.median")
plot_us_category("Income & Savings", us_measures_qtr, overdue30to89.all.lcbank, "value.group.median")
plot_us_category("Debt", us_measures_qtr, overdue30to89.all.lcbank, "value.group.median")
plot_us_category("Economy", us_measures_qtr, overdue30to89.all.lcbank, "value.group.median")

```

:::


## Granger Test

 Intuitively, changes in the macroeconomic environment will take time to impact credit card deliquency. We can test for significance of different lags using the Granger test for each variable.

"X is said to Granger-cause Y if Y can be better predicted using the histories of both X and Y than it can by using the history of Y alone."[@granger2011]

The tables presented below, show the macroeconomic variable and lag (Df column) that Granger-cause *`r credit_card.target_label()`* (Y).

::: {#fig-granger .panel-tabset}

## Combined

```{r}
#| warning: false
#| error: false
#| label: tbl-granger-comb
#| tbl-cap: "Granger Test at Lags 1 to 4"
#| tbl-subcap:
#|   - "Post Regulatory Changes 2010 Q2"
#|   - "Series from 2002 Q4"
#| layout-ncol: 1

granger_test_permutations(data = overdue30to89.post |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "value.all.median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category)) |> rmarkdown::paged_table()

granger_test_permutations(data = overdue30to89.all |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "value.all.median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category)) |> rmarkdown::paged_table()

```


## Large Bank

```{r}
#| warning: false
#| error: false
#| label: tbl-granger-lb
#| tbl-cap: "Granger Test at Lags 1 to 4"
#| tbl-subcap:
#|   - "Post Regulatory Changes 2010 Q2"
#|   - "Series from 2002 Q4"
#| layout-ncol: 1

granger_test_permutations(data = overdue30to89.post.lbank |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "value.group.median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category)) |> rmarkdown::paged_table()  

granger_test_permutations(data = overdue30to89.all.lbank |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "value.group.median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category)) |> rmarkdown::paged_table()  

```
## Large Credit Card Bank

```{r}
#| warning: false
#| error: false
#| label: tbl-granger-lcb
#| tbl-cap: "Granger Test at Lags 1 to 4"
#| tbl-subcap:
#|   - "Post Regulatory Changes 2010 Q2"
#|   - "Series from 2002 Q4"
#| layout-ncol: 1

granger_test_permutations(data = overdue30to89.post.lcbank |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "value.group.median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category)) |> rmarkdown::paged_table()  

granger_test_permutations(data = overdue30to89.all.lcbank |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "value.group.median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category)) |> rmarkdown::paged_table()  

```

:::

## Cross-Correlation Function 

The Cross-Correlation function measures the correlation between series X at time $t+k$ and series Y at time $t$, for various lags $k$. A positive $k$ indicates future values of X relative to Y, conversely, a negative $k$ indicates past values of X relative to Y.

Below tests various macroeconomic variables (X) against *`r credit_card.target_label()`* (Y).

::: {#fig-ccf .panel-tabset}

## Combined

```{r}
#| warning: false
#| error: false
#| label: fig-ccf
#| fig-cap: "Cross-Correlation Function"
#| fig-subcap:
#|   - "RRSFS.Pop - Real Advance Retail and Food Services Sales per capita"
#|   - "CDSP - Consumer Debt Service Payments as a Percent of Disposable Personal Income"
#|   - "UNRATE - Unemployment Rate"
#| layout-ncol: 3

run_ccf_test(data = overdue30to89.all |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "value.all.median",
             exog_variable = "RRSFS.Pop",
             do_difference = TRUE)

run_ccf_test(data = overdue30to89.post |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "value.all.median",
             exog_variable = "CDSP",
             do_difference = TRUE)    

run_ccf_test(data = overdue30to89.post |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "value.all.median",
             exog_variable = "UNRATE",
             do_difference = TRUE)                          

```
## Large Bank

```{r}
#| warning: false
#| error: false
#| label: fig-ccf-lb
#| fig-cap: "Cross-Correlation Function"
#| fig-subcap:
#|   - "RRSFS.Pop - Real Advance Retail and Food Services Sales per capita"
#|   - "CDSP - Consumer Debt Service Payments as a Percent of Disposable Personal Income"
#|   - "UNRATE - Unemployment Rate"
#| layout-ncol: 3
run_ccf_test(data = overdue30to89.all.lbank |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "value.group.median",
             exog_variable = "RRSFS.Pop",
             do_difference = TRUE)

run_ccf_test(data = overdue30to89.post.lbank |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "value.group.median",
             exog_variable = "CDSP",
             do_difference = TRUE)    

run_ccf_test(data = overdue30to89.post.lbank |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "value.group.median",
             exog_variable = "UNRATE",
             do_difference = TRUE)                          

```

## Large Credit Card Bank

```{r}
#| warning: false
#| error: false
#| label: fig-ccf-lcb
#| fig-cap: "Cross-Correlation Function"
#| fig-subcap:
#|   - "RRSFS.Pop - Real Advance Retail and Food Services Sales per capita"
#|   - "CDSP - Consumer Debt Service Payments as a Percent of Disposable Personal Income"
#|   - "UNRATE - Unemployment Rate"
#| layout-ncol: 3
run_ccf_test(data = overdue30to89.all.lcbank |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "value.group.median",
             exog_variable = "RRSFS.Pop",
             do_difference = TRUE)

run_ccf_test(data = overdue30to89.post.lcbank |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "value.group.median",
             exog_variable = "CDSP",
             do_difference = TRUE)    

run_ccf_test(data = overdue30to89.post.lcbank |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "value.group.median",
             exog_variable = "UNRATE",
             do_difference = TRUE)                                  

```

:::

### Cross-Correlation between macro economic variables

@fig-ccf-rrsfs assumes *Real Advance Retail and Food Services Sales per capita* (RRSFS.Pop) is our dependant variable (Y). we observe significant correlations at both positive and negative lags. This pattern indicates a bidirectional or feedback relationship between X and the dependent variable Y. For example, @fig-ccf-rrsfs-2 shows significant correlation at -1 lag suggesting that changes in unemployment have an impact on retail and food sales in the next quarter. But there's also a weaker but significant correlation at +1 which suggests a change in retail and food sales impacts unemployment in the following quarter. To remove the potential risk of multicollinearity we would only have one of these variables included in the same model.  

```{r}
#| warning: false
#| error: false
#| label: fig-ccf-rrsfs
#| fig-cap: "Cross-Correlation Function"
#| fig-subcap:
#|   - "CCF for RRSFS.Pop (Y) and CDSP (X)"
#|   - "CCF for RRSFS.Pop (Y) and UNRATE (X)"
#| layout-ncol: 2 
run_ccf_test(data = us_measures_qtr,
             target_variable = "RRSFS.Pop",
             exog_variable = "CDSP",
             do_difference = TRUE)

run_ccf_test(data = us_measures_qtr,
             target_variable = "RRSFS.Pop",
             exog_variable = "UNRATE",
             do_difference = TRUE)                  

```

## References