---
title: "US Economic Data"
format: 
   html:
     df-print: paged
---

US Federal Reserve Economic Data [@fred]

Yearly/Quarterly/Monthly data series covering various categories. For this project we are interested in data series that tell us about the financial health of households:
Employment rate
Personal Savings Rate
Disposable Income

@taghiyeh2021


```{r}
#| echo: false
#| warning: false
source('functions.R')
                
granger_test_permutations <- function(data, target_col_name = "target_mean", exog_names, max_lag = 4) {
    results <- list()
    for (lag in 1:max_lag) {
        results[[lag]] <- exog_names |>
                            purrr::map(\(x) run_granger_test(data, target_col_name, x, lag)) |> list_rbind() |> arrange(`Pr(>F)`) |> filter(`Pr(>F)` <= 0.05) |> mutate(across(F:`Pr(>F)`, ~ round(.,3))) |> select(-Res.Df)       
    } 
    results 
}    

us_measures <- us_economy() |>
            mutate(B069RC1.Pop.CPI =B069RC1/POPTHM/PCEPI) |>
            mutate(PCEDG.Pop.CPI = PCEDG/POPTHM/PCEPI) |>
            mutate(PCE.Pop.CPI = PCE/POPTHM/PCEPI) |>
            mutate(RRSFS.Pop = RRSFS/POPTHM) |> 
            mutate(A229RC0.CPI = A229RC0/PCEPI) |> 
            #mutate(PSAVE.Pop.CPI = PSAVE/POPTHM/PCEPI) |>
            select(-c(RRSFS,PSAVE,A229RC0,CPILFESL,CPIAUCSL,DSPI,DSPIC96,B069RC1,PCEDG,PCE,POPTHM,PCEPI))

us_measures_qtr <- us_measures |>
                    mutate(Quarter = yearquarter(Month)) |>
                    index_by(Quarter) |>
                    summarise(across(!Month, mean))
                    #filter(Quarter >= yearquarter(get_regulation_cutoff())) 
                    
apply_bank_filters = TRUE
apply_reg_filter = FALSE
overdue30to89.all <- credit_card.overdue30to89.agg(apply_bank_filters, apply_reg_filter) 
overdue30to89.all.lcbank <- credit_card.overdue30to89.agg.lccbank(apply_bank_filters, apply_reg_filter)
overdue30to89.all.lbank <-  credit_card.overdue30to89.agg.lbank(apply_bank_filters, apply_reg_filter)

apply_reg_filter = TRUE  
overdue30to89.post <- credit_card.overdue30to89.agg(apply_bank_filters, apply_reg_filter)       
overdue30to89.post.lcbank <- credit_card.overdue30to89.agg.lccbank(apply_bank_filters, apply_reg_filter)
overdue30to89.post.lbank <-  credit_card.overdue30to89.agg.lbank(apply_bank_filters, apply_reg_filter)             

```
## Granger Test

Checks that the lagged values of X jointly improve the forecast of Y

When choosing lags, note that there is a trade-off between bias and power. With too few lags the test may be biased because of residual auto-correlation. Too many, and you risk spurious rejections of the null because of random correlations

::: {#fig-granger .panel-tabset}

## Combined

```{r}
#| warning: false
#| error: false
#| label: tbl-granger-comb
#| tbl-cap: "Granger Test at Lags 1 to 4"
#| tbl-subcap:
#|   - "All Series from 2002 Q4"
#|   - "Post Regulatory Changes 2010 Q2"
#| layout-ncol: 1

granger_test_permutations(data = overdue30to89.all |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "target_median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category))  

granger_test_permutations(data = overdue30to89.post |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "target_median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category))  
```


## Large Bank

```{r}
#| warning: false
#| error: false
#| label: tbl-granger-lb
#| tbl-cap: "Granger Test at Lags 1 to 4"
#| tbl-subcap:
#|   - "All Series from 2002 Q4"
#|   - "Post Regulatory Changes 2010 Q2"
#| layout-ncol: 1

 
granger_test_permutations(data = overdue30to89.all.lbank |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "target_median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category))  

granger_test_permutations(data = overdue30to89.post.lbank |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "target_median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category))  


```
## Large Credit Card Bank

```{r}
#| warning: false
#| error: false
#| label: tbl-granger-lcb
#| tbl-cap: "Granger Test at Lags 1 to 4"
#| tbl-subcap:
#|   - "All Series from 2002 Q4"
#|   - "Post Regulatory Changes 2010 Q2"
#| layout-ncol: 1

 
granger_test_permutations(data = overdue30to89.all.lcbank |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "target_median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category))  

granger_test_permutations(data = overdue30to89.post.lcbank |> left_join (us_measures_qtr,by = join_by(Quarter)), 
                            target_col_name = "target_median",
                            exog_names = names(us_measures_qtr),
                            max_lag = 4) |> list_rbind() |> left_join(us_economy.labels(), join_by(exog_variable==Name)) |> select(-c(Formula, Category))  


```

:::

## CCF 
```{r}
#| warning: false
#| error: false
#| label: fig-ccf

run_ccf_test(data = overdue30to89.all |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "target_mean",
             exog_variable = "RRSFS.Pop",
             do_difference = TRUE)

run_ccf_test(data = overdue30to89.post |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "target_mean",
             exog_variable = "A229RC0.CPI",
             do_difference = TRUE)    

run_ccf_test(data = overdue30to89.post |> left_join (us_measures_qtr,by = join_by(Quarter)),
             target_variable = "target_mean",
             exog_variable = "UNRATE",
             do_difference = TRUE)                          
#us_measures_qtr |> names() |> purrr::map(\(x) run_ccf_test(overdue30to89 |> left_join (us_measures_qtr,by = join_by(Quarter)), "target_mean", x, 4))

```

## US Economic Measures

::: {#fig-usmeasures .panel-tabset}

## Combined
```{r}
#| warning: false
#| error: false

plot_us_category("Expenditures",us_measures_qtr, overdue30to89.all)
plot_us_category("Income & Savings",us_measures_qtr, overdue30to89.all)
plot_us_category("Other",us_measures_qtr, overdue30to89.all)
```



## Large Bank
```{r}
#| warning: false
#| error: false

plot_us_category("Expenditures", us_measures_qtr, overdue30to89.all.lbank)
plot_us_category("Income & Savings", us_measures_qtr, overdue30to89.all.lbank)
plot_us_category("Other", us_measures_qtr, overdue30to89.all.lbank)
```

## Large Credit Card Bank
```{r}
#| warning: false
#| error: false

plot_us_category("Expenditures", us_measures_qtr, overdue30to89.all.lcbank)
plot_us_category("Income & Savings", us_measures_qtr, overdue30to89.all.lcbank)
plot_us_category("Other", us_measures_qtr, overdue30to89.all.lcbank)
```

:::
