---
title: "Data Outliers"
format: html
---

```{r}
#| echo: false
#| warning: false
#| error: false

library(broom)
source('functions.R')

plot_extremes <- function(data_w_features,feature_name) {
  outlier_banks <- data_w_features |>
                    group_by(BankType) |>
                    filter(!!as.name(feature_name) %in% range(!!as.name(feature_name)))|> 
                    distinct(BankName)
  data_w_features |>
    filter(BankName %in% outlier_banks$BankName) |>
    select(-Measure,Description) |>
    ggplot(aes(x = Quarter, y = Value, col = BankName)) +
    geom_line()+
    facet_wrap(~BankType) + 
    theme(legend.position = "top", legend.direction = "vertical") +
    labs(title = glue("Banks - Most and Least {feature_name}") )
}


regulation_cutoff <- "2010-02-22"

overdue30to89 <- credit_card.overdue_3089() |>
                    filter_index(regulation_cutoff ~ .) 
               
```

```{r}
#| warning: false
#| error: false
#| label: fig-lfeature
#| fig-cap: "Exploring Statistical Features"
#| fig-subcap:
#|   - "Lumpiness - variance of the variances based on tiled (non-overlapping) windows"
#|   - "Stability - the variance of the means based on tiled (non-overlapping) windows"
#|   - "Seasonal Strength - For non-seasonal time series seasonal strength is 0"
#|   - "Trend Strength - 0 is week, 1 is strong"
#|   - "Linearity - large values when the series is nonlinear, and values around 0 when the series is linear"
#|   - "Autocorrelation - first autocorrelation coefficient. Coefficient close to 0 indicates weak or no linear relationship between lagged values. Negative values indicate tendency for a short-term reversal."
#|   - "Minimum number of differences necessary to obtain a stationary time series"
#| layout-ncol: 2

all_f <- overdue30to89 |> features(Value, feature_set(tags = c("lumpiness","stability","seasonal",quantile)))

all_f |> plot_feature_violin("var_tiled_var")


all_f |> plot_feature_violin("var_tiled_mean")

all_f |> features(Value, feature_set(tags = "seasonal")) 

all_f |> plot_feature_violin("seasonal_strength_year")

all_f |> plot_feature_violin("trend_strength")

all_f |> plot_feature_violin("linearity")

all_f |> plot_feature_violin("stl_e_acf1")

all_f |> plot_feature_violin("nsdiffs")

```

```{r}







outliers <- pcs |>
  filter( (.fittedPC2 > 2.5) | (.fittedPC1 > 4)) |>
  select(IDRSSD) |> bind_rows(outliers)

overdue30to89 %>% 
filter(IDRSSD %in% outliers$IDRSSD) |>
  ggplot(aes(x = Quarter, y = Value, col = BankName)) +
  geom_line() +
  facet_wrap(~BankName, ncol = 1, scales = "free_y") +
  theme(legend.position = "none")  +
  labs(title = "Principal components outlier Banks",
    subtitle = "US Credit Cards 30-89 days")   


ggplot(overdue30to89, aes(x=Value, colour = BankType, fill=BankType))+ geom_density(alpha = .3)

ggplot(overdue30to89, aes(x=Value, fill=BankType)) +
    geom_histogram(binwidth=.5, alpha=.5, position="identity")
```









outlier_banks <- post_features |>
        group_by(BankType) |>
        filter(!!as.name(feature_name) %in% range(!!as.name(feature_name))) |> distinct(BankName)

outlier_banks$BankName

post_features %>%
  right_join(extreme_seasonalities) %>%
  ggplot(aes(x = Quarter, y = Value)) +
  geom_line() +
  facet_grid(vars(BankName, scales::percent(seasonal_strength_year)),
             scales = "free_y")


pcs |>
  ggplot(aes(x = .fittedPC1, y = .fittedPC2, col = BankName)) +
  geom_point() +
  theme(aspect.ratio = 1) +
  labs(title = "US Credit Cards 30-89 days",
       subtitle = "Principal components",
       x = "PC1",
       y = "PC2")+ theme(legend.position="none")

outlier_firms <- pcs |>
  filter( (.fittedPC2 > 2) | (.fittedPC1 < -7)) |>
  select(BankName,  .fittedPC1, .fittedPC2)

overdue30to89_post %>% 

